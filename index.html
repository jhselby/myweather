<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- iOS Web App Config -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Wyman Cove" />

  <title>Wyman Cove Weather</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255, 255, 255, 0.06);
      --card2: rgba(255, 255, 255, 0.09);
      --border: rgba(255, 255, 255, 0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --muted2: rgba(255,255,255,0.55);
      --accent: rgba(255,255,255,0.18);
      --shadow: 0 10px 28px rgba(0,0,0,0.35);
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(84, 150, 255, 0.25), transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, rgba(90, 255, 190, 0.12), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 16px 14px 28px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px 14px 12px;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,0.05);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    header h1 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: 0.2px;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .version-pill{
      font-size: 0.78rem;
      font-weight: 800;
      color: rgba(255,255,255,0.78);
      border: 1px solid rgba(255,255,255,0.18);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      white-space: nowrap;
    }

    .meta-row{
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .meta-item{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
    }

    .meta-label{
      color: rgba(255,255,255,0.55);
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .meta-value{
      color: rgba(255,255,255,0.86);
      font-weight: 800;
    }

    .source-row{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .source-pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      font-size: 0.82rem;
      font-weight: 800;
      color: rgba(255,255,255,0.86);
    }
    .source-pill .small{
      font-weight: 800;
      color: rgba(255,255,255,0.65);
    }

    .tabs{
      margin-top: 6px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .tab{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      transition: transform 0.06s ease, background 0.15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .tab:active{ transform: scale(0.98); }
    .tab.active{
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.28);
    }

    .grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .card{
      grid-column: span 6;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .card.col-12{ grid-column: span 12; }
    .card.col-6{ grid-column: span 6; }

    .card-title{
      font-weight: 900;
      color: rgba(255,255,255,0.88);
      font-size: 0.95rem;
      letter-spacing: 0.2px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }

    .small-note{
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
      line-height: 1.2rem;
      margin-top: 8px;
    }

    .current-temp{
      font-size: 3rem;
      font-weight: 1000;
      letter-spacing: -1px;
      margin-top: 8px;
    }

    .temp-unit{
      font-size: 1.25rem;
      font-weight: 900;
      color: rgba(255,255,255,0.7);
      margin-left: 6px;
    }

    .feels-like{
      margin-top: 2px;
      font-size: 1rem;
      color: rgba(255,255,255,0.76);
      font-weight: 800;
    }

    .condition{
      margin-top: 10px;
      font-size: 1.05rem;
      font-weight: 900;
      color: rgba(255,255,255,0.86);
    }

    .row{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 7px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 0.95rem;
    }
    .row:last-child{ border-bottom: none; }

    .label{
      color: rgba(255,255,255,0.62);
      font-weight: 800;
    }
    .value{
      color: rgba(255,255,255,0.9);
      font-weight: 900;
      text-align: right;
      white-space: nowrap;
    }

    .alert-banner{
      background: rgba(255, 80, 80, 0.18);
      border: 1px solid rgba(255, 80, 80, 0.30);
      border-radius: 16px;
      padding: 12px 14px;
      margin-top: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .alert-title{ font-weight: 1000; }
    .alert-desc{ color: rgba(255,255,255,0.78); margin-top: 4px; }

    .tide-grid{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .tide-item{
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.05);
    }
    .tide-item .tide-type{
      font-weight: 1000;
      color: rgba(255,255,255,0.85);
      margin-bottom: 2px;
    }
    .tide-item .tide-time{
      font-weight: 900;
      color: rgba(255,255,255,0.78);
    }
    .tide-item .tide-height{
      font-weight: 900;
      color: rgba(255,255,255,0.72);
      font-size: 0.9rem;
    }

    canvas{
      width: 100% !important;
      height: 220px !important;
    }

    @media (max-width: 780px){
      .card{ grid-column: span 12; }
      canvas{ height: 240px !important; }
      header{ position: relative; top: 0; }
    }
    /* --- iOS Chart Fix --- */
    canvas {
    display: block;  
    }

    #windChart {
    width: 100% !important;
    height: 220px !important;
    }

    /* Make 48-hour charts less “stretched” on wide screens */
  @media (min-width: 900px) {
  #tempPrecipChart, #windChart {
    height: 420px !important;
  }
}

/* Also helps iPhone landscape / tablet landscape */
@media (orientation: landscape) and (max-width: 900px) {
  #tempPrecipChart, #windChart {
    height: 260px !important;
  }
}
  /* --- Wind Risk tiles --- */
.risk-tiles{
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin: 12px 0 14px 0;
}

@media (max-width: 780px){
  .risk-tiles{
    grid-template-columns: repeat(2, 1fr);
  }
}

.risk-tile{
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.04);
  border-radius: 16px;
  padding: 12px 12px 10px 12px;
}

.risk-tile .kicker{
  font-weight: 700;
  opacity: 0.85;
  margin-bottom: 6px;
}

.risk-tile .big{
  font-size: 22px;
  font-weight: 800;
  line-height: 1.05;
  margin-bottom: 4px;
}

.risk-tile .sub{
  font-size: 13px;
  opacity: 0.7;
}

/* Risk badge colors */
.badge{
  display: inline-block;
  padding: 3px 9px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
  margin-left: 6px;
  border: 1px solid rgba(255,255,255,0.15);
}

.badge.calm         { background: rgba(160,160,160,0.18); }
.badge.breezy       { background: rgba(100,180,255,0.22); }
.badge.notable      { background: rgba(255,170,0,0.22); }
.badge.significant  { background: rgba(255,80,80,0.25); }
.badge.severe       { background: rgba(200,60,255,0.30); }
  
    /* Radar tab */
    .radar-btn {
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.6);
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 0.78rem;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.15s;
    }
    .radar-btn:hover { background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.9); }
    .radar-btn-active {
      background: rgba(100,180,255,0.18) !important;
      border-color: rgba(100,180,255,0.5) !important;
      color: rgba(140,210,255,0.95) !important;
    }
    /* Override Leaflet defaults for dark theme */
    .leaflet-container { background: #0b1220 !important; }
    .leaflet-control-attribution {
      background: rgba(0,0,0,0.6) !important;
      color: rgba(255,255,255,0.4) !important;
      font-size: 10px !important;
    }
    .leaflet-control-attribution a { color: rgba(255,255,255,0.5) !important; }
    .leaflet-control-zoom a {
      background: rgba(20,30,50,0.9) !important;
      color: rgba(255,255,255,0.8) !important;
      border-color: rgba(255,255,255,0.15) !important;
    }
</style>
</head>

<body>
  <div class="container">
    <header>
      <h1>
        ⚓ Wyman Cove Weather
        <span class="version-pill" id="appVersion">v2.0</span>
      </h1>

      <div class="meta-row">
        <div class="meta-item">
          <span class="meta-label">Location</span>
          <span class="meta-value" id="location">Loading…</span>
        </div>

        <div class="meta-item">
          <span class="meta-label">Data generated</span>
          <span class="meta-value" id="dataUpdated">--</span>
        </div>

        <div class="meta-item">
          <span class="meta-label">Page loaded</span>
          <span class="meta-value" id="pageLoaded">--</span>
        </div>
      </div>

      <div class="source-row" id="sourceRow"></div>

      <nav class="tabs" role="tablist" aria-label="Views">
        <button class="tab active" id="tabWeather" role="tab" aria-selected="true" onclick="showTab('weather')">Weather</button>
        <button class="tab" id="tabWind" role="tab" aria-selected="false" onclick="showTab('wind')">Wind</button>
        <button class="tab" id="tabAlmanac" role="tab" aria-selected="false" onclick="showTab('almanac')">Almanac</button>
        <button class="tab" id="tabRadar"   role="tab" aria-selected="false" onclick="showTab('radar')">Radar</button>
      </nav>
    </header>

    <div id="alertsContainer"></div>

    <!-- WEATHER VIEW -->
    <section id="weatherView">
      <div class="grid">
        <!-- Current Conditions -->
        <div class="card col-6">
          <div class="card-title">Current Conditions</div>
          <div id="currentTemp" class="current-temp">--<span class="temp-unit">&deg;F</span></div>
          <div id="feelsLike" class="feels-like">Feels like --&deg;F</div>
          <div id="condition" class="condition">Loading&hellip;</div>
        </div>

        <!-- Hyperlocal Comparison -->
        <div class="card col-6">
          <div class="card-title">&#127968; Hyperlocal Comparison</div>
          <div class="row">
            <div class="label">Model Temp</div>
            <div class="value" id="modelTemp">--&deg;F</div>
          </div>
          <div class="row">
            <div class="label">PWS Temp</div>
            <div class="value" id="pwsTemp">--&deg;F</div>
          </div>
          <div class="row">
            <div class="label">Bias</div>
            <div class="value" id="tempBias">--&deg;F</div>
          </div>
          <div class="row">
            <div class="label">Corrected</div>
            <div class="value" id="correctedTemp">--&deg;F</div>
          </div>
          <div class="small-note" id="pwsNote"></div>
        </div>

        <!-- Today's Summary -->
        <div class="card col-6">
          <div class="card-title">Today&#39;s Summary</div>
          <div class="row">
            <div class="label">High / Low</div>
            <div class="value" id="hiLo">-- / --</div>
          </div>
          <div class="row">
            <div class="label">Precip Chance</div>
            <div class="value" id="precipChance">--%</div>
          </div>
          <div class="row">
            <div class="label">Wind (now)</div>
            <div class="value" id="windNowHome">--</div>
          </div>
          <div class="row">
            <div class="label">Pressure Trend (2h)</div>
            <div class="value" id="pressureTrendHome">--</div>
          </div>
          <div class="small-note" id="todayNote"></div>
        </div>

        <!-- 10-Day Forecast -->
        <div class="card col-6">
          <div class="card-title">10-Day Forecast</div>
          <div id="forecastList"></div>
        </div>

        <!-- 48-Hour Temperature & Precipitation -->
        <div class="card col-12">
          <div class="card-title">48-Hour Temperature &amp; Precipitation</div>
          <canvas id="tempPrecipChart"></canvas>
        </div>

        <!-- NWS Detailed Forecast -->
        <div class="card col-12">
          <div class="card-title">&#128204; NWS Detailed Forecast
            <span style="font-size:0.78rem;font-weight:700;color:rgba(255,255,255,0.45);margin-left:8px;" id="nwsOfficeLabel"></span>
          </div>
          <div id="nwsForecastList"></div>
          <div style="margin-top:10px;">
            <button id="nwsExpandBtn" onclick="nwsToggleExpand()"
              style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);
                     color:rgba(255,255,255,0.7);border-radius:999px;padding:6px 16px;
                     font-size:0.82rem;font-weight:800;cursor:pointer;display:none;">
              Show all periods
            </button>
          </div>
          <div class="small-note" style="margin-top:8px;">Written by NWS Boston meteorologists.</div>
        </div>

      </div>
    </section>
    <!-- WIND VIEW -->
    <section id="windView" style="display:none;">
      <div class="grid">

        <!-- Window selector — full width bar above both cards -->
        <div class="card col-12" style="padding:10px 14px;display:flex;align-items:center;gap:12px;">
          <span style="color:rgba(255,255,255,0.65);font-size:0.88rem;font-weight:800;letter-spacing:0.2px;">Forecast window</span>
          <select id="riskWindowSelect" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.9);border-radius:999px;padding:5px 12px;font-weight:800;font-size:0.85rem;cursor:pointer;">
            <option value="12">12h</option>
            <option value="24">24h</option>
            <option value="36">36h</option>
            <option value="48">48h</option>
          </select>
          <span style="color:rgba(255,255,255,0.38);font-size:0.82rem;margin-left:4px;">applies to both panels</span>
        </div>

        <!-- Gust Worry -->
        <div class="card col-6">
          <div class="card-title">&#127788; Gust Worry</div>
          <div class="row">
            <div class="label">Level</div>
            <div class="value" id="gustLevel">--</div>
          </div>
          <div class="row">
            <div class="label">Worry Score</div>
            <div class="value" id="gustScore">--</div>
          </div>
          <div class="row">
            <div class="label">Peak Gust</div>
            <div class="value" id="gustPeak">-- mph</div>
          </div>
          <div class="row">
            <div class="label">Direction</div>
            <div class="value" id="gustDir">--</div>
          </div>
          <div class="row">
            <div class="label">Exposure Factor</div>
            <div class="value" id="gustExposure">--</div>
          </div>
          <div class="row">
            <div class="label">Peak Time</div>
            <div class="value" id="gustTime">--</div>
          </div>
          <div class="small-note" id="gustNote"></div>
        </div>

        <!-- Sustained Worry -->
        <div class="card col-6">
          <div class="card-title">&#127787; Sustained Worry</div>
          <div class="row">
            <div class="label">Level</div>
            <div class="value" id="susLevel">--</div>
          </div>
          <div class="row">
            <div class="label">Worry Score</div>
            <div class="value" id="susScore">--</div>
          </div>
          <div class="row">
            <div class="label">Peak Speed</div>
            <div class="value" id="susPeak">-- mph</div>
          </div>
          <div class="row">
            <div class="label">Direction</div>
            <div class="value" id="susDir">--</div>
          </div>
          <div class="row">
            <div class="label">Exposure Factor</div>
            <div class="value" id="susExposure">--</div>
          </div>
          <div class="row">
            <div class="label">Peak Time</div>
            <div class="value" id="susTime">--</div>
          </div>
          <div class="small-note" id="susNote">Sustained = dock lines, outdoor use. Gust = structural stress.</div>
        </div>

        <!-- Wind & Pressure (now) -->
        <div class="card col-12">
          <div class="card-title">Wind &amp; Pressure (now)</div>
          <div class="row">
            <div class="label">Wind</div>
            <div class="value" id="windNowWind">--</div>
          </div>
          <div class="row">
            <div class="label">Gusts</div>
            <div class="value" id="windGustsWind">--</div>
          </div>
          <div class="row">
            <div class="label">Pressure</div>
            <div class="value" id="pressureNowWind">--</div>
          </div>
          <div class="row">
            <div class="label">Trend (2h)</div>
            <div class="value" id="pressureTrendWind">--</div>
          </div>
          <div class="small-note" id="windPressureNote"></div>
        </div>

        <!-- 48-Hour Wind Forecast -->
        <div class="card col-12">
          <div class="card-title">48-Hour Wind Forecast</div>
          <canvas id="windChart"></canvas>
        </div>
      </div>
    </section>

    <!-- ALMANAC VIEW -->
    <section id="almanacView" style="display:none;">
      <div class="grid">

        <!-- Tides full width -->
        <div class="card col-12">
          <div class="card-title">&#127754; Tides &#8212; Salem Harbor</div>
          <div id="tideGrid"></div>
          <div class="small-note" id="nextTideNote"></div>
          <canvas id="tideChart" style="margin-top:18px;max-height:200px;"></canvas>
        </div>

        <!-- Sun full width, 3-column -->
        <div class="card col-12">
          <div class="card-title" id="sunCardTitle">&#9728;&#65039; Sun</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0;">

            <!-- Summary column -->
            <div style="padding-right:16px;border-right:1px solid rgba(255,255,255,0.08);">
              <div style="font-size:3.5rem;line-height:1;margin-bottom:6px;" id="sunEmoji">&#9728;&#65039;</div>
              <div style="font-weight:900;font-size:1rem;color:rgba(255,255,255,0.9);margin-bottom:4px;" id="sunStatus">--</div>
              <div style="font-size:0.88rem;color:rgba(255,255,255,0.6);font-weight:800;" id="daylight">-- daylight</div>
              <div style="font-size:0.85rem;color:rgba(255,255,255,0.5);margin-top:6px;" id="solarNoonLabel">Solar noon: --</div>
            </div>

            <!-- Times column -->
            <div style="padding:0 16px;border-right:1px solid rgba(255,255,255,0.08);">
              <div class="row">
                <div class="label">Sunrise</div>
                <div class="value" id="sunrise">--</div>
              </div>
              <div class="row">
                <div class="label">Sunset</div>
                <div class="value" id="sunset">--</div>
              </div>
              <div class="row">
                <div class="label">Civil Dawn</div>
                <div class="value" id="civilDawn">--</div>
              </div>
              <div class="row" style="border-bottom:none;">
                <div class="label">Civil Dusk</div>
                <div class="value" id="civilDusk">--</div>
              </div>
            </div>

            <!-- Position column -->
            <div style="padding-left:16px;">
              <div class="row">
                <div class="label">Direction</div>
                <div class="value" id="sunAzimuth">--</div>
              </div>
              <div class="row">
                <div class="label">Altitude</div>
                <div class="value" id="sunAltitude">--</div>
              </div>
              <div class="row">
                <div class="label">Golden Hour AM</div>
                <div class="value" id="goldenHourAM">--</div>
              </div>
              <div class="row" style="border-bottom:none;">
                <div class="label">Golden Hour PM</div>
                <div class="value" id="goldenHourPM">--</div>
              </div>
            </div>

          </div>
          <div class="small-note" id="sunNote" style="margin-top:10px;"></div>
        </div>

        <!-- Moon — full width -->
        <div class="card col-12">
          <div class="card-title" id="moonCardTitle">&#127769; Moon</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0;">

            <!-- Phase column -->
            <div style="padding-right:16px;border-right:1px solid rgba(255,255,255,0.08);">
              <div style="font-size:3.5rem;line-height:1;margin-bottom:6px;" id="moonEmoji">&#127769;</div>
              <div style="font-weight:900;font-size:1rem;color:rgba(255,255,255,0.9);margin-bottom:4px;" id="moonPhaseName">--</div>
              <div style="font-size:0.88rem;color:rgba(255,255,255,0.6);font-weight:800;" id="moonIllumination">-- % illuminated</div>
            </div>

            <!-- Rise / Set column -->
            <div style="padding:0 16px;border-right:1px solid rgba(255,255,255,0.08);">
              <div class="row">
                <div class="label">Moonrise</div>
                <div class="value" id="moonrise">--</div>
              </div>
              <div class="row">
                <div class="label">Moonset</div>
                <div class="value" id="moonset">--</div>
              </div>
              <div class="row" style="border-bottom:none;">
                <div class="label">Next Full Moon</div>
                <div class="value" id="nextFullMoon">--</div>
              </div>
            </div>

            <!-- Position column -->
            <div style="padding-left:16px;">
              <div class="row">
                <div class="label">Direction</div>
                <div class="value" id="moonAzimuth">--</div>
              </div>
              <div class="row">
                <div class="label">Altitude</div>
                <div class="value" id="moonAltitude">--</div>
              </div>
              <div class="row" style="border-bottom:none;">
                <div class="label">Visible</div>
                <div class="value" id="moonVisible">--</div>
              </div>
            </div>

          </div>
          <div class="small-note" id="moonNote" style="margin-top:10px;"></div>
        </div>

      </div>
    </section>

    <!-- RADAR VIEW -->
    <section id="radarView" style="display:none;">
      <div class="grid">
        <div class="card col-12" style="padding:0;overflow:hidden;border-radius:18px;">

          <!-- Controls bar -->
          <div id="radarControls" style="
            display:flex;align-items:center;gap:12px;flex-wrap:wrap;
            padding:12px 16px;background:rgba(255,255,255,0.05);
            border-bottom:1px solid rgba(255,255,255,0.08);">

            <span style="font-weight:900;font-size:0.9rem;color:rgba(255,255,255,0.85);">
              &#127941; Radar
            </span>

            <!-- Layer selector -->
            <div style="display:flex;gap:6px;margin-left:4px;">
              <button onclick="setRadarLayer('radar')"   id="btnLayerRadar"
                class="radar-btn radar-btn-active">Radar</button>
              <button onclick="setRadarLayer('satellite')" id="btnLayerSat"
                class="radar-btn">Satellite</button>
              <button onclick="setRadarLayer('clouds')"  id="btnLayerClouds"
                class="radar-btn">Clouds</button>
            </div>

            <!-- Spacer -->
            <div style="flex:1;"></div>

            <!-- Timestamp -->
            <span id="radarTimestamp" style="font-size:0.8rem;color:rgba(255,255,255,0.5);font-weight:700;"></span>

            <!-- Play/Pause -->
            <button id="radarPlayBtn" onclick="radarTogglePlay()"
              style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
                     color:rgba(255,255,255,0.85);border-radius:999px;padding:5px 14px;
                     font-size:0.82rem;font-weight:900;cursor:pointer;">
              &#9654; Play
            </button>

          </div>

          <!-- Map -->
          <div id="radarMap" style="height:520px;width:100%;background:#0b1220;"></div>

          <!-- Frame scrubber -->
          <div style="padding:8px 16px 10px;background:rgba(255,255,255,0.03);
                      border-top:1px solid rgba(255,255,255,0.06);">
            <input type="range" id="radarScrubber" min="0" max="0" value="0"
              oninput="radarScrubTo(this.value)"
              style="width:100%;accent-color:rgba(100,180,255,0.9);cursor:pointer;">
            <div style="display:flex;justify-content:space-between;
                        font-size:0.75rem;color:rgba(255,255,255,0.35);font-weight:700;margin-top:2px;">
              <span id="radarScrubStart">--</span>
              <span style="color:rgba(255,255,255,0.45);">&#9664; Past &nbsp;&nbsp; Future &#9654;</span>
              <span id="radarScrubEnd">--</span>
            </div>
          </div>

        </div>
      </div>
    </section>

  </div>

  <script>
    // ======================================================
    // Tab behavior — Weather / Wind / Almanac
    // ======================================================
    function showTab(which) {
      const views = { weather: "weatherView", wind: "windView", almanac: "almanacView", radar: "radarView" };
      const tabs  = { weather: "tabWeather",  wind: "tabWind",  almanac: "tabAlmanac",  radar: "tabRadar"  };
      Object.keys(views).forEach(k => {
        const v = document.getElementById(views[k]);
        const t = document.getElementById(tabs[k]);
        if (v) v.style.display = (k === which) ? "" : "none";
        if (t) {
          t.classList.toggle("active", k === which);
          t.setAttribute("aria-selected", String(k === which));
        }
      });
      try { localStorage.setItem("activeTab", which); } catch(e) {}
      if (which === "radar") initRadar();
    }

    (function restoreTab() {
      try {
        const t = localStorage.getItem("activeTab");
        if (["wind","almanac","radar"].includes(t)) showTab(t);
      } catch(e) {}
    })();

    // ======================================================
    // Formatting helpers
    // ======================================================
    const weatherEmoji = {
      0: "&#9728;&#65039;", 1: "&#127780;&#65039;", 2: "&#9925;", 3: "&#9729;&#65039;",
      45: "&#127787;&#65039;", 48: "&#127787;&#65039;",
      51: "&#127782;&#65039;", 53: "&#127783;&#65039;", 55: "&#127783;&#65039;",
      61: "&#127783;&#65039;", 63: "&#127783;&#65039;", 65: "&#127783;&#65039;",
      71: "&#127784;&#65039;", 73: "&#127784;&#65039;", 75: "&#127784;&#65039;",
      77: "&#127784;&#65039;", 80: "&#127782;&#65039;", 81: "&#127782;&#65039;", 82: "&#127783;&#65039;",
      85: "&#127784;&#65039;", 86: "&#127784;&#65039;",
      95: "&#9928;&#65039;", 96: "&#9928;&#65039;", 99: "&#9928;&#65039;"
    };

    const weatherDesc = {
      0: "Clear", 1: "Mostly Clear", 2: "Partly Cloudy", 3: "Overcast",
      45: "Fog", 48: "Freezing Fog",
      51: "Light Drizzle", 53: "Drizzle", 55: "Heavy Drizzle",
      61: "Light Rain", 63: "Rain", 65: "Heavy Rain",
      71: "Light Snow", 73: "Snow", 75: "Heavy Snow",
      77: "Snow Grains", 80: "Light Showers", 81: "Showers", 82: "Heavy Showers",
      85: "Light Snow Showers", 86: "Heavy Snow Showers",
      95: "Thunderstorm", 96: "Thunderstorm + Hail", 99: "Severe Thunderstorm"
    };

    function fmtLocal(dt) {
      if (!dt) return "--";
      const d = new Date(dt);
      if (isNaN(d.getTime())) return "--";
      return d.toLocaleString("en-US", { month: "short", day: "numeric", hour: "numeric", minute: "2-digit" });
    }

    // Single canonical compass function — replaces both old degreesToCompass and degToCompass
    function toCompass(deg, withDeg = true) {
      if (deg == null || isNaN(deg)) return "--";
      const d = ((deg % 360) + 360) % 360;
      const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      const label = dirs[Math.round(d / 22.5) % 16];
      return withDeg ? `${Math.round(d)}° ${label}` : label;
    }

    // ======================================================
    // Wind Exposure Table (mirrors collector.py exactly)
    // ======================================================
    const WIND_EXPOSURE_TABLE = [
      [  0,  20, 1.00],
      [ 20,  60, 0.90],
      [ 60,  90, 0.70],
      [ 90, 130, 0.50],
      [130, 165, 0.20],
      [165, 200, 0.10],
      [200, 255, 0.05],
      [255, 285, 0.30],
      [285, 315, 0.70],
      [315, 360, 0.95],
    ];

    const WORRY_NOTICEABLE  =  5;
    const WORRY_NOTABLE     = 12;
    const WORRY_SIGNIFICANT = 20;
    const WORRY_SEVERE      = 30;

    function getExposureFactor(deg) {
      const d = ((deg % 360) + 360) % 360;
      for (const [minD, maxD, factor] of WIND_EXPOSURE_TABLE) {
        if (minD <= maxD) {
          if (d >= minD && d < maxD) return factor;
        } else {
          if (d >= minD || d < maxD) return factor;
        }
      }
      return 0.5;
    }

    function worryScore(speed, expFactor) {
      return speed * Math.pow(expFactor, 1.5);
    }

    function worryLevel(score) {
      if (score >= WORRY_SEVERE)      return { label: "SEVERE",      cls: "severe"      };
      if (score >= WORRY_SIGNIFICANT) return { label: "SIGNIFICANT", cls: "significant" };
      if (score >= WORRY_NOTABLE)     return { label: "NOTABLE",     cls: "notable"     };
      if (score >= WORRY_NOTICEABLE)  return { label: "BREEZY",      cls: "breezy"      };
      return                                 { label: "CALM",         cls: "calm"        };
    }

    function computePeakWorry(hourly, windowHours, useGusts) {
      const values = useGusts ? (hourly?.wind_gusts || []) : (hourly?.wind_speed || []);
      const dirs   = hourly?.wind_direction || [];
      const times  = hourly?.times || [];
      const n = Math.min(windowHours, values.length, dirs.length);

      let bestScore = -1, bestIdx = -1;
      for (let i = 0; i < n; i++) {
        const v = values[i], d = dirs[i];
        if (v == null || d == null) continue;
        const ef = getExposureFactor(d);
        const ws = worryScore(v, ef);
        if (ws > bestScore) { bestScore = ws; bestIdx = i; }
      }
      if (bestIdx < 0) return null;

      const d = dirs[bestIdx];
      const ef = getExposureFactor(d);
      return {
        speed:          values[bestIdx],
        directionDeg:   d,
        exposureFactor: ef,
        score:          worryScore(values[bestIdx], ef),
        timeISO:        times[bestIdx] || null
      };
    }

    // ======================================================
    // Charts
    // ======================================================
    let tempPrecipChart = null;
    let windChartObj    = null;

    function buildTempPrecipChart(times, temps, pop) {
      const labels   = times.map(t => new Date(t).toLocaleTimeString("en-US", { hour: "numeric" }));
      const ctx      = document.getElementById("tempPrecipChart").getContext("2d");
      if (tempPrecipChart) tempPrecipChart.destroy();
      tempPrecipChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Temp (°F)", data: temps.map(v => v ?? null), yAxisID: "y",  tension: 0.25 },
            { label: "Precip %",       data: pop.map(v => v ?? null),   yAxisID: "y1", tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "rgba(255,255,255,0.8)" } } },
          scales: {
            x:  { ticks: { color: "rgba(255,255,255,0.7)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y:  { ticks: { color: "rgba(255,255,255,0.7)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y1: { position: "right", min: 0, max: 100,
                  ticks: { color: "rgba(255,255,255,0.7)" }, grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    function buildWindChart(times, speeds, gusts) {
      const labels = times.map(t => new Date(t).toLocaleTimeString("en-US", { hour: "numeric" }));
      const ctx    = document.getElementById("windChart").getContext("2d");
      if (windChartObj) windChartObj.destroy();
      windChartObj = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Wind (mph)", data: speeds.map(v => v ?? null), yAxisID: "y", tension: 0.25 },
            { label: "Gust (mph)", data: gusts.map(v => v ?? null),  yAxisID: "y", tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "rgba(255,255,255,0.8)" } } },
          scales: {
            x: { ticks: { color: "rgba(255,255,255,0.7)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y: { ticks: { color: "rgba(255,255,255,0.7)" }, grid: { color: "rgba(255,255,255,0.06)" } }
          }
        }
      });
    }

    // ======================================================
    // Rendering functions
    // ======================================================
    function renderSources(sources) {
      const row = document.getElementById("sourceRow");
      if (!row || !sources) return;
      row.innerHTML = "";
      const order = ["gfs_current", "hrrr_hourly", "ecmwf_daily", "pws", "tides", "nws_forecast", "nws_alerts"];
      const names = {
        gfs_current: "GFS", hrrr_hourly: "HRRR", ecmwf_daily: "ECMWF",
        pws: "PWS", tides: "Tides", nws_forecast: "NWS", nws_alerts: "Alerts"
      };
      order.forEach(key => {
        const s = sources[key];
        if (!s) return;
        const ok  = s.status === "ok";
        const age = typeof s.age_minutes === "number" ? `${s.age_minutes.toFixed(1)}m` : "--";
        const pill = document.createElement("div");
        pill.className = "source-pill";
        pill.innerHTML = `${ok ? "&#9989;" : "&#10060;"} ${names[key]} <span class="small">(${age})</span>`;
        row.appendChild(pill);
      });
    }

    let tideChartObj = null;

    function renderTides(tides) {
      const grid = document.getElementById("tideGrid");
      const note = document.getElementById("nextTideNote");
      if (!grid) return;
      grid.innerHTML = "";
      if (note) note.textContent = "";
      if (!Array.isArray(tides) || tides.length === 0) {
        if (note) note.textContent = "No tide data available.";
        return;
      }

      const todayStr = new Date().toISOString().split("T")[0];
      const nowMins  = new Date().getHours() * 60 + new Date().getMinutes();

      // Find next upcoming tide
      let nextIdx = -1;
      for (let i = 0; i < tides.length; i++) {
        const tDate = tides[i].date || todayStr;
        const [th, tm] = (tides[i].time || "00:00").split(":").map(Number);
        if (tDate > todayStr || (tDate === todayStr && (th * 60 + tm) >= nowMins)) {
          nextIdx = i;
          break;
        }
      }

      // Group by date, cap at 4 per day, total 8 max
      const byDate = {};
      let total = 0;
      tides.forEach(t => {
        if (total >= 8) return;
        const d = t.date || todayStr;
        if (!byDate[d]) byDate[d] = [];
        if (byDate[d].length >= 4) return;
        byDate[d].push(t);
        total++;
      });

      const today = new Date().toISOString().split("T")[0];
      const tmrw  = new Date(Date.now() + 86400000).toISOString().split("T")[0];

      let tideIdx = 0;
      Object.keys(byDate).sort().forEach(dateKey => {
        const label = dateKey === today ? "Today" :
                      dateKey === tmrw  ? "Tomorrow" :
                      new Date(dateKey + "T12:00:00").toLocaleDateString("en-US",
                        { weekday:"long", month:"short", day:"numeric" });

        const hdr = document.createElement("div");
        hdr.style.cssText = "font-size:0.8rem;font-weight:900;color:rgba(255,255,255,0.45);" +
                            "letter-spacing:0.8px;text-transform:uppercase;margin:12px 0 6px;";
        hdr.textContent = label;
        grid.appendChild(hdr);

        const row = document.createElement("div");
        row.style.cssText = "display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:4px;";

        const dayTiles = byDate[dateKey];
        dayTiles.forEach(t => {
          const isNext = (tideIdx === nextIdx);
          const tile   = document.createElement("div");
          tile.className = "tide-item";
          if (isNext) tile.style.cssText =
            "border:1px solid rgba(100,200,255,0.45);background:rgba(100,200,255,0.08);border-radius:10px;";
          tile.innerHTML =
            '<div class="tide-type">' + (isNext ? "&#9654; " : "") +
              (t.type === "H" ? "High" : "Low") + '</div>' +
            '<div class="tide-time">' + t.time + '</div>' +
            '<div class="tide-height">' + (t.height ?? "--") + ' ft</div>';
          row.appendChild(tile);
          tideIdx++;
        });

        // Pad empty cells so grid stays 4-column
        for (let i = dayTiles.length; i < 4; i++) {
          row.appendChild(document.createElement("div"));
        }

        grid.appendChild(row);
      });

      if (note) note.textContent = "Salem Harbor (8442645) \u2014 harmonic predictions. \u25b6 = next tide.";
    }

    function buildTideChart(curve, events) {
      const ctx = document.getElementById("tideChart");
      if (!ctx || !curve || !Array.isArray(curve.times) || curve.times.length === 0) return;

      // Thin to every 3rd point (~18-min resolution) to keep chart snappy
      const step = 3;
      const labels  = [];
      const heights = [];
      for (let i = 0; i < curve.times.length; i += step) {
        const raw = curve.times[i]; // "YYYY-MM-DD HH:MM"
        const d   = new Date(raw.replace(" ", "T"));
        labels.push(d.toLocaleTimeString("en-US",
          { weekday: undefined, hour: "numeric", minute: "2-digit" }));
        heights.push(curve.heights[i]);
      }

      // Now-line index (closest point to current time)
      const nowMs = Date.now();
      let nowLineIdx = 0;
      let minDiff   = Infinity;
      for (let i = 0; i < curve.times.length; i += step) {
        const d    = new Date(curve.times[i].replace(" ", "T"));
        const diff = Math.abs(d.getTime() - nowMs);
        if (diff < minDiff) { minDiff = diff; nowLineIdx = Math.floor(i / step); }
      }

      // Annotation points for H/L events
      const pointColors = heights.map(() => "transparent");
      const pointRadius = heights.map(() => 0);

      if (tideChartObj) tideChartObj.destroy();
      tideChartObj = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Tide Height (ft)",
              data: heights,
              borderColor:     "rgba(100,180,255,0.85)",
              backgroundColor: "rgba(100,180,255,0.08)",
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 4,
            },
            // Vertical now-line via a second dataset with a single point
            {
              label: "Now",
              data: labels.map((_, i) => i === nowLineIdx ? heights[i] : null),
              borderColor:  "rgba(255,220,80,0.9)",
              backgroundColor: "rgba(255,220,80,0.9)",
              borderWidth: 0,
              pointRadius: labels.map((_, i) => i === nowLineIdx ? 8 : 0),
              pointStyle:  "triangle",
              fill: false,
              tension: 0,
              showLine: false,
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ctx.datasetIndex === 0
                  ? " " + ctx.parsed.y.toFixed(1) + " ft"
                  : " Now"
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "rgba(255,255,255,0.45)",
                maxTicksLimit: 12,
                maxRotation: 0,
                font: { size: 10, weight: "700" }
              },
              grid: { color: "rgba(255,255,255,0.04)" }
            },
            y: {
              ticks: {
                color: "rgba(255,255,255,0.55)",
                callback: v => v.toFixed(1) + " ft",
                font: { size: 10, weight: "700" }
              },
              grid: { color: "rgba(255,255,255,0.06)" }
            }
          }
        }
      });
    }

    function renderForecast(daily) {
      const el = document.getElementById("forecastList");
      if (!el || !daily || !Array.isArray(daily.dates)) return;
      el.innerHTML = "";
      for (let i = 0; i < Math.min(10, daily.dates.length); i++) {
        const date  = new Date(daily.dates[i] + "T00:00:00");
        const day   = date.toLocaleDateString("en-US", { weekday: "short" });
        const hi    = daily.temperature_max?.[i];
        const lo    = daily.temperature_min?.[i];
        const code  = daily.weather_code?.[i];
        const emoji = weatherEmoji[code] || "&#127777;&#65039;";
        const row   = document.createElement("div");
        row.className = "row";
        row.innerHTML = `<div class="label">${day} ${emoji}</div>
                         <div class="value">${Math.round(hi)}° / ${Math.round(lo)}°</div>`;
        el.appendChild(row);
      }
    }

    function fillWorryCard(ids, peak, windowHours) {
      // ids: { level, score, peakSpd, dir, exposure, time, note }
      if (!peak) {
        document.getElementById(ids.level).textContent   = "--";
        document.getElementById(ids.score).textContent   = "--";
        document.getElementById(ids.peakSpd).textContent = "-- mph";
        document.getElementById(ids.dir).textContent     = "--";
        document.getElementById(ids.exposure).textContent= "--";
        document.getElementById(ids.time).textContent    = "--";
        return;
      }
      const wl = worryLevel(peak.score);
      document.getElementById(ids.level).innerHTML =
        `<span class="badge ${wl.cls}">${wl.label}</span>`;
      document.getElementById(ids.score).textContent   = peak.score.toFixed(1);
      document.getElementById(ids.peakSpd).textContent = `${Math.round(peak.speed)} mph`;
      document.getElementById(ids.dir).textContent     = toCompass(peak.directionDeg);
      document.getElementById(ids.exposure).textContent= `${(peak.exposureFactor * 100).toFixed(0)}%`;
      document.getElementById(ids.time).textContent    = peak.timeISO ? fmtLocal(peak.timeISO) : "--";
    }

    function renderWindRisk(data) {
      const windowSelect = document.getElementById("riskWindowSelect");
      const hours = parseInt(windowSelect?.value || "12", 10);
      const hourly = data.hourly || {};

      const gustPeak = computePeakWorry(hourly, hours, true);
      const susPeak  = computePeakWorry(hourly, hours, false);

      fillWorryCard(
        { level:"gustLevel", score:"gustScore", peakSpd:"gustPeak",
          dir:"gustDir", exposure:"gustExposure", time:"gustTime", note:"gustNote" },
        gustPeak, hours
      );
      fillWorryCard(
        { level:"susLevel", score:"susScore", peakSpd:"susPeak",
          dir:"susDir", exposure:"susExposure", time:"susTime", note:"susNote" },
        susPeak, hours
      );

      const noteEl = document.getElementById("gustNote");
      if (noteEl) noteEl.textContent = `Peak gust worry over next ${hours}h. Score = gust × exposure¹·5.`;
    }

    // ======================================================
    // Sun (SunCalc)
    // ======================================================
    function renderSun(daily) {
      if (typeof SunCalc === "undefined") return;

      const now  = new Date();
      const pos  = SunCalc.getPosition(now, HOME_LAT, HOME_LON);
      const times= SunCalc.getTimes(now, HOME_LAT, HOME_LON);

      // Altitude and status
      const altDeg = Math.round(pos.altitude * 180 / Math.PI);
      let status, emoji;
      if (altDeg >= 20)       { status = "Above horizon";        emoji = "\u2600\uFE0F"; }
      else if (altDeg >= 5)   { status = "Low in sky";           emoji = "\uD83C\uDF05"; }
      else if (altDeg >= 0)   { status = "Just above horizon";   emoji = "\uD83C\uDF05"; }
      else if (altDeg >= -6)  { status = "Civil twilight";       emoji = "\uD83C\uDF06"; }
      else if (altDeg >= -12) { status = "Nautical twilight";    emoji = "\uD83C\uDF06"; }
      else if (altDeg >= -18) { status = "Astronomical twilight";emoji = "\uD83C\uDF11"; }
      else                    { status = "Below horizon (night)"; emoji = "\uD83C\uDF11"; }

      document.getElementById("sunEmoji").textContent   = emoji;
      document.getElementById("sunStatus").textContent  = status;
      document.getElementById("sunCardTitle").innerHTML = emoji + " Sun \u2014 " + status;

      // Azimuth
      const azDeg = Math.round(((pos.azimuth * 180 / Math.PI) + 360) % 360);
      const dirs  = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      const compass = dirs[Math.round(azDeg / 22.5) % 16];
      document.getElementById("sunAzimuth").textContent  = azDeg + "\u00b0 " + compass;
      document.getElementById("sunAltitude").textContent = altDeg + "\u00b0";

      // Twilight times from SunCalc
      document.getElementById("civilDawn").textContent =
        fmtTime(times.dawn)    || "--";
      document.getElementById("civilDusk").textContent =
        fmtTime(times.dusk)    || "--";

      // Golden hour
      document.getElementById("goldenHourAM").textContent =
        (times.goldenHourEnd ? fmtTime(times.sunrise) + "\u2013" + fmtTime(times.goldenHourEnd) : "--");
      document.getElementById("goldenHourPM").textContent =
        (times.goldenHour    ? fmtTime(times.goldenHour) + "\u2013" + fmtTime(times.sunset)      : "--");

      // Solar noon from SunCalc (more precise than midpoint calc)
      document.getElementById("solarNoonLabel").textContent =
        "Solar noon: " + (fmtTime(times.solarNoon) || "--");

      // Daylight from the daily JSON (already computed in boot)
      // Note: sunNote shows calculation time
      document.getElementById("sunNote").textContent =
        "Position calculated for " +
        now.toLocaleTimeString("en-US", { hour:"numeric", minute:"2-digit" }) + " local time.";
    }

    // ======================================================
    // Radar (Leaflet + RainViewer)
    // ======================================================
    let radarMap       = null;
    let radarLayer     = null;
    let radarFrames    = [];
    let radarFrameIdx  = 0;
    let radarPlaying   = false;
    let radarTimer     = null;
    let radarInited    = false;
    let radarLayerType = "radar";   // "radar" | "satellite" | "clouds"

    const RADAR_CENTER = [42.5014, -70.8750];
    const RADAR_ZOOM   = 8;
    const FRAME_DELAY  = 400;  // ms between animation frames

    function initRadar() {
      if (radarInited) return;
      radarInited = true;

      // Base tile layer — dark CartoDB
      radarMap = L.map("radarMap", {
        center: RADAR_CENTER,
        zoom:   RADAR_ZOOM,
        zoomControl: true,
        attributionControl: true,
      });

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "&copy; <a href='https://carto.com/'>CARTO</a> &copy; OpenStreetMap contributors",
          subdomains: "abcd",
          maxZoom: 19,
        }
      ).addTo(radarMap);

      // Home marker
      L.circleMarker(RADAR_CENTER, {
        radius: 7,
        fillColor: "rgba(100,200,255,0.9)",
        color: "rgba(255,255,255,0.8)",
        weight: 2,
        fillOpacity: 1,
      }).bindTooltip("16 Indianhead Circle", { permanent: false }).addTo(radarMap);

      // Load RainViewer data
      fetchRainViewer();
    }

    function fetchRainViewer() {
      fetch("https://api.rainviewer.com/public/weather-maps.json")
        .then(r => r.json())
        .then(data => {
          // Build frame list based on layer type
          buildFrames(data);
        })
        .catch(err => {
          document.getElementById("radarTimestamp").textContent = "Radar unavailable";
          console.error("RainViewer error:", err);
        });
    }

    function buildFrames(data) {
      radarFrames = [];

      if (radarLayerType === "radar") {
        const past   = data.radar?.past   || [];
        const nowcast= data.radar?.nowcast || [];
        past.forEach(f => radarFrames.push({ ts: f.time, path: f.path, future: false }));
        nowcast.forEach(f => radarFrames.push({ ts: f.time, path: f.path, future: true }));
      } else if (radarLayerType === "satellite") {
        const sat = data.satellite?.infrared || [];
        sat.forEach(f => radarFrames.push({ ts: f.time, path: f.path, future: false }));
      } else if (radarLayerType === "clouds") {
        const sat = data.satellite?.infrared || [];
        sat.forEach(f => radarFrames.push({ ts: f.time, path: f.path, future: false }));
      }

      if (radarFrames.length === 0) {
        document.getElementById("radarTimestamp").textContent = "No frames available";
        return;
      }

      // Start at most recent past frame
      radarFrameIdx = radarFrames.filter(f => !f.future).length - 1;
      if (radarFrameIdx < 0) radarFrameIdx = 0;

      // Update scrubber
      const scrubber = document.getElementById("radarScrubber");
      scrubber.max   = radarFrames.length - 1;
      scrubber.value = radarFrameIdx;

      // Label scrubber ends
      const fmtTs = ts => new Date(ts * 1000).toLocaleTimeString("en-US",
        { hour:"numeric", minute:"2-digit" });
      document.getElementById("radarScrubStart").textContent = fmtTs(radarFrames[0].ts);
      document.getElementById("radarScrubEnd").textContent   =
        fmtTs(radarFrames[radarFrames.length - 1].ts);

      showFrame(radarFrameIdx);
    }

    function showFrame(idx) {
      if (!radarMap || radarFrames.length === 0) return;
      idx = Math.max(0, Math.min(idx, radarFrames.length - 1));
      radarFrameIdx = idx;

      const frame   = radarFrames[idx];
      const tileUrl = "https://tilecache.rainviewer.com" + frame.path +
                      "/256/{z}/{x}/{y}/4/1_1.png";

      if (radarLayer) {
        radarMap.removeLayer(radarLayer);
      }

      radarLayer = L.tileLayer(tileUrl, {
        opacity:     0.75,
        maxZoom:     15,
        attribution: "&copy; <a href='https://rainviewer.com'>RainViewer</a>",
      }).addTo(radarMap);

      // Update UI
      const ts   = new Date(frame.ts * 1000);
      const label= ts.toLocaleTimeString("en-US", { hour:"numeric", minute:"2-digit" });
      const tag  = frame.future ? " (forecast)" : "";
      document.getElementById("radarTimestamp").textContent = label + tag;

      const scrubber = document.getElementById("radarScrubber");
      scrubber.value = idx;
    }

    function radarTogglePlay() {
      radarPlaying = !radarPlaying;
      const btn = document.getElementById("radarPlayBtn");
      if (radarPlaying) {
        btn.textContent = "&#9646;&#9646; Pause";
        radarAdvance();
      } else {
        btn.textContent = "&#9654; Play";
        clearTimeout(radarTimer);
      }
    }

    function radarAdvance() {
      if (!radarPlaying) return;
      radarFrameIdx = (radarFrameIdx + 1) % radarFrames.length;
      showFrame(radarFrameIdx);
      radarTimer = setTimeout(radarAdvance, FRAME_DELAY);
    }

    function radarScrubTo(val) {
      radarPlaying = false;
      document.getElementById("radarPlayBtn").textContent = "&#9654; Play";
      clearTimeout(radarTimer);
      showFrame(parseInt(val));
    }

    function setRadarLayer(type) {
      radarLayerType = type;
      // Update button states
      ["radar","satellite","clouds"].forEach(t => {
        const btn = document.getElementById(
          "btnLayer" + t.charAt(0).toUpperCase() + t.slice(1));
        if (btn) btn.classList.toggle("radar-btn-active", t === type);
      });
      // Reload frames
      if (radarInited) {
        if (radarLayer) { radarMap.removeLayer(radarLayer); radarLayer = null; }
        radarFrames = [];
        document.getElementById("radarTimestamp").textContent = "Loading...";
        fetchRainViewer();
      }
    }

    // ======================================================
    // Moon (SunCalc)
    // ======================================================
    const HOME_LAT = 42.5014;
    const HOME_LON = -70.8750;

    const MOON_PHASES = [
      { name: "New Moon",        emoji: "\u{1F311}", min: 0,     max: 0.025 },
      { name: "Waxing Crescent", emoji: "\u{1F312}", min: 0.025, max: 0.235 },
      { name: "First Quarter",   emoji: "\u{1F313}", min: 0.235, max: 0.265 },
      { name: "Waxing Gibbous",  emoji: "\u{1F314}", min: 0.265, max: 0.485 },
      { name: "Full Moon",       emoji: "\u{1F315}", min: 0.485, max: 0.515 },
      { name: "Waning Gibbous",  emoji: "\u{1F316}", min: 0.515, max: 0.735 },
      { name: "Last Quarter",    emoji: "\u{1F317}", min: 0.735, max: 0.765 },
      { name: "Waning Crescent", emoji: "\u{1F318}", min: 0.765, max: 0.975 },
      { name: "New Moon",        emoji: "\u{1F311}", min: 0.975, max: 1.0   },
    ];

    function getMoonPhase(fraction) {
      return MOON_PHASES.find(p => fraction >= p.min && fraction < p.max) || MOON_PHASES[0];
    }

    function fmtTime(date) {
      if (!date || isNaN(date.getTime())) return "--";
      return date.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" });
    }

    function azimuthToSky(azRad) {
      const d = ((azRad * 180 / Math.PI) + 360) % 360;
      const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      const compass = dirs[Math.round(d / 22.5) % 16];
      return { deg: Math.round(d), compass };
    }

    function altitudeDescription(altRad) {
      const deg = Math.round(altRad * 180 / Math.PI);
      let text;
      if (deg < 0)  text = "Below horizon";
      else if (deg < 10) text = "Just above horizon";
      else if (deg < 30) text = "Low in sky";
      else if (deg < 60) text = "Mid sky";
      else               text = "High overhead";
      return { deg, text };
    }

    function daysUntilNextFullMoon() {
      const now = new Date();
      let prev = SunCalc.getMoonIllumination(now).phase;
      for (let d = 1; d <= 30; d++) {
        const candidate = new Date(now.getTime() + d * 86400000);
        const phase = SunCalc.getMoonIllumination(candidate).phase;
        if (prev < 0.5 && phase >= 0.5) return d;
        prev = phase;
      }
      return null;
    }

    function renderMoon() {
      if (typeof SunCalc === "undefined") {
        document.getElementById("moonNote").textContent = "SunCalc library not loaded.";
        return;
      }
      const now   = new Date();
      const illum = SunCalc.getMoonIllumination(now);
      const times = SunCalc.getMoonTimes(now, HOME_LAT, HOME_LON);
      const pos   = SunCalc.getMoonPosition(now, HOME_LAT, HOME_LON);

      const phase = getMoonPhase(illum.phase);
      document.getElementById("moonEmoji").textContent        = phase.emoji;
      document.getElementById("moonPhaseName").textContent    = phase.name;
      document.getElementById("moonIllumination").textContent = Math.round(illum.fraction * 100) + "% illuminated";
      document.getElementById("moonCardTitle").innerHTML      = phase.emoji + " Moon — " + phase.name;

      document.getElementById("moonrise").textContent =
        times.rise ? fmtTime(times.rise) : (times.alwaysUp ? "Up all night" : "Doesn't rise today");
      document.getElementById("moonset").textContent =
        times.set  ? fmtTime(times.set)  : (times.alwaysDown ? "Below horizon all day" : "--");

      const daysToFull = daysUntilNextFullMoon();
      document.getElementById("nextFullMoon").textContent =
        daysToFull === null ? "--" :
        daysToFull === 0    ? "Tonight" :
        daysToFull === 1    ? "Tomorrow" :
        "In " + daysToFull + " days";

      const az  = azimuthToSky(pos.azimuth);
      const alt = altitudeDescription(pos.altitude);
      document.getElementById("moonAzimuth").textContent  = az.deg + "\u00b0 " + az.compass;
      document.getElementById("moonAltitude").textContent = alt.deg + "\u00b0 \u2014 " + alt.text;
      document.getElementById("moonVisible").textContent  = alt.deg >= 0 ? "Yes" : "No (below horizon)";
      document.getElementById("moonNote").textContent     =
        "Position calculated for " + now.toLocaleTimeString("en-US", { hour:"numeric", minute:"2-digit" }) + " local time.";
    }

    // ======================================================
    // NWS Detailed Forecast
    // ======================================================
    let nwsShowAll = false;
    const NWS_PREVIEW = 5;  // periods shown before "show all"

    function renderNWSForecast(periods) {
      const list = document.getElementById("nwsForecastList");
      const btn  = document.getElementById("nwsExpandBtn");
      if (!list || !Array.isArray(periods) || periods.length === 0) {
        if (list) list.innerHTML =
          '<div style="color:rgba(255,255,255,0.4);font-size:0.88rem;padding:8px 0;">No forecast available.</div>';
        return;
      }

      function renderPeriods(all) {
        const toShow = all ? periods : periods.slice(0, NWS_PREVIEW);
        list.innerHTML = "";
        toShow.forEach((p, i) => {
          const isDay   = p.is_daytime !== false;
          const bgAlpha = isDay ? "0.05" : "0.03";
          const row     = document.createElement("div");
          row.style.cssText =
            "display:grid;grid-template-columns:130px 1fr;" +
            "gap:0;border-bottom:1px solid rgba(255,255,255,0.06);" +
            "padding:10px 0;";

          // Left: name + temp + wind
          const left = document.createElement("div");
          left.style.cssText = "padding-right:16px;";
          left.innerHTML =
            '<div style="font-weight:900;font-size:0.9rem;color:rgba(255,255,255,0.9);">' +
              p.name + '</div>' +
            '<div style="font-size:1.4rem;font-weight:900;color:rgba(255,255,255,0.85);margin:2px 0;">' +
              (p.temperature != null ? p.temperature + "\u00b0F" : "--") + '</div>' +
            '<div style="font-size:0.78rem;color:rgba(255,255,255,0.5);font-weight:700;">' +
              (p.wind_speed || "") + " " + (p.wind_direction || "") + '</div>';

          // Right: short forecast bold + detailed text
          const right = document.createElement("div");
          right.innerHTML =
            '<div style="font-weight:900;font-size:0.88rem;color:rgba(255,255,255,0.8);margin-bottom:4px;">' +
              p.short_forecast + '</div>' +
            '<div style="font-size:0.85rem;color:rgba(255,255,255,0.6);line-height:1.5;">' +
              p.detailed + '</div>';

          row.appendChild(left);
          row.appendChild(right);
          list.appendChild(row);
        });

        // Last row — remove bottom border
        const rows = list.querySelectorAll("div[style*='border-bottom']");
        if (rows.length > 0) rows[rows.length-1].style.borderBottom = "none";
      }

      renderPeriods(false);

      if (periods.length > NWS_PREVIEW) {
        btn.style.display = "inline-block";
        btn.textContent   = "Show all " + periods.length + " periods \u25be";
      } else {
        btn.style.display = "none";
      }
    }

    function nwsToggleExpand() {
      const btn     = document.getElementById("nwsExpandBtn");
      const periods = window._nwsPeriods || [];
      nwsShowAll    = !nwsShowAll;

      const list = document.getElementById("nwsForecastList");
      const toShow = nwsShowAll ? periods : periods.slice(0, NWS_PREVIEW);
      list.innerHTML = "";
      toShow.forEach(p => {
        const row = document.createElement("div");
        row.style.cssText =
          "display:grid;grid-template-columns:130px 1fr;" +
          "gap:0;border-bottom:1px solid rgba(255,255,255,0.06);padding:10px 0;";
        const left = document.createElement("div");
        left.style.cssText = "padding-right:16px;";
        left.innerHTML =
          '<div style="font-weight:900;font-size:0.9rem;color:rgba(255,255,255,0.9);">' + p.name + '</div>' +
          '<div style="font-size:1.4rem;font-weight:900;color:rgba(255,255,255,0.85);margin:2px 0;">' +
            (p.temperature != null ? p.temperature + "\u00b0F" : "--") + '</div>' +
          '<div style="font-size:0.78rem;color:rgba(255,255,255,0.5);font-weight:700;">' +
            (p.wind_speed || "") + " " + (p.wind_direction || "") + '</div>';
        const right = document.createElement("div");
        right.innerHTML =
          '<div style="font-weight:900;font-size:0.88rem;color:rgba(255,255,255,0.8);margin-bottom:4px;">' +
            p.short_forecast + '</div>' +
          '<div style="font-size:0.85rem;color:rgba(255,255,255,0.6);line-height:1.5;">' +
            p.detailed + '</div>';
        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      });
      const rows = list.querySelectorAll("div[style*='border-bottom']");
      if (rows.length > 0) rows[rows.length-1].style.borderBottom = "none";

      btn.textContent = nwsShowAll
        ? "Show fewer \u25b4"
        : "Show all " + periods.length + " periods \u25be";
    }

    // ======================================================
    // Boot: load data and populate all views
    // ======================================================
    document.getElementById("pageLoaded").textContent =
      new Date().toLocaleString("en-US", { month: "short", day: "numeric", hour: "numeric", minute: "2-digit" });

    fetch("weather_data.json?t=" + Date.now())
      .then(r => r.json())
      .then(data => {
        window.__lastWeatherData = data;

        // Header
        document.getElementById("location").textContent    = data.location?.name ?? "Wyman Cove";
        document.getElementById("dataUpdated").textContent = fmtLocal(data.generated_at || data.location?.updated);
        renderSources(data.sources);

        // Alerts
        const alertsContainer = document.getElementById("alertsContainer");
        alertsContainer.innerHTML = "";
        if (data.alerts && data.alerts.length > 0) {
          alertsContainer.innerHTML = data.alerts.map(a => `
            <a href="${a.url}" target="_blank" style="text-decoration:none;color:inherit;display:block;">
              <div class="alert-banner">
                <div class="alert-title">&#9888;&#65039; ${a.headline || a.event || "Weather Alert"}</div>
                <div class="alert-desc">${a.description || ""}</div>
              </div>
            </a>`).join("");
        }

        // Current conditions
        const cur   = data.current || {};
        const code  = cur.weather_code;
        const emoji = cur.emoji || weatherEmoji[code] || "&#127777;&#65039;";
        const desc  = cur.condition || weatherDesc[code] || "—";
        document.getElementById("currentTemp").innerHTML =
          `${Math.round(cur.temperature ?? 0)}<span class="temp-unit">°F</span>`;
        document.getElementById("feelsLike").textContent =
          `Feels like ${Math.round(cur.feels_like ?? 0)}°F`;
        document.getElementById("condition").innerHTML = `${emoji} ${desc}`;

        // Hyperlocal
        const pws = data.pws || {};
        const hyp = data.hyperlocal || {};
        document.getElementById("modelTemp").textContent    = (cur.temperature ?? "--") + "°F";
        document.getElementById("pwsTemp").textContent      = (pws.temperature ?? "--") + "°F";
        document.getElementById("tempBias").textContent     = (hyp.bias_temp ?? "--") + "°F";
        document.getElementById("correctedTemp").textContent= (hyp.corrected_temp ?? "--") + "°F";
        document.getElementById("pwsNote").textContent      =
          pws.stale ? "PWS is stale (cached) — using last good reading." : "PWS is fresh.";

        // Today summary
        const daily = data.daily || {};
        const hi    = daily.temperature_max?.[0];
        const lo    = daily.temperature_min?.[0];
        document.getElementById("hiLo").textContent =
          (hi != null && lo != null) ? `${Math.round(hi)}° / ${Math.round(lo)}°` : "-- / --";
        const popMax = daily.precipitation_probability_max?.[0];
        document.getElementById("precipChance").textContent =
          popMax != null ? `${Math.round(popMax)}%` : "--%";

        const der   = data.derived || {};
        const trend = der.pressure_trend ?? "--";
        const delta = typeof der.pressure_trend_hpa_2h === "number"
          ? `${der.pressure_trend_hpa_2h.toFixed(1)} hPa/2h` : "";
        document.getElementById("pressureTrendHome").textContent = delta ? `${trend} (${delta})` : trend;
        document.getElementById("todayNote").textContent =
          cur.time ? `Current time in model: ${cur.time}` : "";

        const windNowText = (cur.wind_speed != null && cur.wind_direction != null)
          ? `${Math.round(cur.wind_speed)} mph ${toCompass(cur.wind_direction, false)}`
          : "--";
        document.getElementById("windNowHome").textContent = windNowText;

        // Forecast
        renderForecast(daily);

        // 48h charts
        const hourly = data.hourly || {};
        const times  = (hourly.times || []).slice(0, 48);
        buildTempPrecipChart(
          times,
          (hourly.temperature || []).slice(0, 48),
          (hourly.precipitation_probability || []).slice(0, 48)
        );
        buildWindChart(
          times,
          (hourly.wind_speed || []).slice(0, 48),
          (hourly.wind_gusts || []).slice(0, 48)
        );

        // Wind tab
        renderWindRisk(data);
        const riskSel = document.getElementById("riskWindowSelect");
        if (riskSel) {
          riskSel.onchange = () => {
            try { renderWindRisk(window.__lastWeatherData || data); }
            catch(e) { console.error("WindRisk onchange failed:", e); }
          };
        }

        const windNowEl      = document.getElementById("windNowWind");
        const windGustsEl    = document.getElementById("windGustsWind");
        const pressureNowEl  = document.getElementById("pressureNowWind");
        const pressureTrendEl= document.getElementById("pressureTrendWind");
        if (windNowEl) windNowEl.textContent =
          (cur.wind_speed != null && cur.wind_direction != null)
            ? `${Math.round(cur.wind_speed)} mph • ${toCompass(cur.wind_direction)}`
            : "--";
        if (windGustsEl)     windGustsEl.textContent     = cur.wind_gusts != null ? `${Math.round(cur.wind_gusts)} mph` : "--";
        if (pressureNowEl)   pressureNowEl.textContent   = cur.pressure  != null ? `${cur.pressure.toFixed(1)} hPa` : "--";
        if (pressureTrendEl) pressureTrendEl.textContent = delta ? `${trend} (${delta})` : trend;

        // NWS Forecast
        window._nwsPeriods = data.nws_forecast || [];
        const nwsOfficeEl = document.getElementById('nwsOfficeLabel');
        if (nwsOfficeEl && data.sources && data.sources.nws_forecast) {
          nwsOfficeEl.textContent = data.sources.nws_forecast.office
            ? '\u2014 ' + data.sources.nws_forecast.office + ' office' : '';
        }
        renderNWSForecast(window._nwsPeriods);

        // Almanac tab
        renderTides(data.tides);
        buildTideChart(data.tide_curve, data.tides);
        const rise = daily.sunrise?.[0]?.split("T")?.[1] ?? "--";
        const set  = daily.sunset?.[0]?.split("T")?.[1] ?? "--";
        document.getElementById("sunrise").textContent = rise;
        document.getElementById("sunset").textContent  = set;

        // Compute daylight duration
        if (rise !== "--" && set !== "--") {
          const [rh, rm] = rise.split(":").map(Number);
          const [sh, sm] = set.split(":").map(Number);
          const mins = (sh * 60 + sm) - (rh * 60 + rm);
          const h = Math.floor(mins / 60), m = mins % 60;
          document.getElementById("daylight").textContent = `${h}h ${m}m daylight`;
        }

        // Sun
        renderSun(daily);

        // Moon
        renderMoon();
      })
      .catch(err => {
        console.error(err);
        document.getElementById("location").textContent = "Error loading weather_data.json";
      });
  </script>

  
</head>

</body>
</html>
