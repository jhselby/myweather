<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wyman Cove Weather</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
  color: white;
  margin: 0;
  padding: 20px;
}
header {
  text-align: center;
  margin-bottom: 20px;
}
h1 { font-weight: 300; }
.status-strip {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.pill {
  padding: 8px 14px;
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,0.2);
  font-weight: 600;
}
.ok   { border-color: #4CAF50; }
.warn { border-color: #ff9800; }
.bad  { border-color: #f44336; }

.card {
  background: rgba(255,255,255,0.1);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}
</style>
</head>

<body>

<header>
  <h1>⚓ Wyman Cove Weather</h1>
  <div id="location">Loading...</div>
  <div id="lastUpdate">Updated: --</div>
  <div id="meta" style="font-size:0.8em; opacity:0.8;"></div>
  <div class="status-strip" id="statusStrip"></div>
</header>

<div class="card">
  <h3>Current Conditions</h3>
  <div id="currentTemp">--°F</div>
  <div id="condition">Loading...</div>
</div>

<script>

const APP_VERSION = "2.0.0";

function pillClass(ageMinutes) {
  if (ageMinutes >= 60) return "pill bad";
  if (ageMinutes >= 30) return "pill warn";
  return "pill ok";
}

function ageText(ageMinutes) {
  if (ageMinutes < 1) return "now";
  return Math.round(ageMinutes) + "m";
}

fetch("weather_data.json?t=" + Date.now())
.then(r => r.json())
.then(data => {

  // LOCATION
  document.getElementById("location").textContent =
    data?.location?.name || "Wyman Cove";

  // UPDATED HEADER
  const updatedStr = data?.generated_at || data?.location?.updated;
  const updatedDate = updatedStr ? new Date(updatedStr) : null;

  function updateHeader() {
    if (!updatedDate) {
      document.getElementById("lastUpdate").textContent = "Updated: --";
      return;
    }

    const human =
      updatedDate.toLocaleDateString("en-US", { month:"short", day:"numeric" }) +
      " " +
      updatedDate.toLocaleTimeString("en-US", { hour:"numeric", minute:"2-digit" });

    const ageMin = (Date.now() - updatedDate.getTime()) / 60000;
    const ageStr = ageMin < 1 ? "now" : Math.round(ageMin) + "m ago";

    document.getElementById("lastUpdate").textContent =
      `Updated: ${human} (${ageStr})`;
  }

  updateHeader();
  setInterval(updateHeader, 60000);

  // VERSION + PAGE LOAD
  const loadTime = new Date().toLocaleTimeString("en-US", {
    hour:"numeric",
    minute:"2-digit",
    second:"2-digit"
  });

  document.getElementById("meta").innerHTML =
    `Version: ${APP_VERSION} <br> Page loaded: ${loadTime}`;

  // STATUS PILLS
  const statusStrip = document.getElementById("statusStrip");

  const ageMin = updatedDate
    ? (Date.now() - updatedDate.getTime()) / 60000
    : 999;

  statusStrip.innerHTML =
    `<div class="${pillClass(ageMin)}">Model: ${ageText(ageMin)}</div>
     <div class="${pillClass(ageMin)}">PWS: ${ageText(ageMin)}</div>
     <div class="${pillClass(ageMin)}">Tides: ${ageText(ageMin)}</div>
     <div class="${pillClass(ageMin)}">Alerts: ${ageText(ageMin)}</div>`;

  // CURRENT CONDITIONS
  const curr = data?.current;
  if (curr && typeof curr.temperature === "number") {
    document.getElementById("currentTemp").textContent =
      curr.temperature.toFixed(1) + "°F";
    document.getElementById("condition").textContent =
      (curr.condition || "");
  }

})
.catch(err => {
  console.error(err);
  document.getElementById("location").textContent = "Error loading data";
});

</script>

</body>
</html>
