<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Wyman Cove" />

  <title>Wyman Cove Weather</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color: #fff;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      min-height:100vh;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    .container { max-width:1400px; margin:0 auto; padding:15px; }

    header {
      text-align:center;
      margin-bottom:20px;
      padding:20px 15px;
      background: rgba(255,255,255,0.1);
      border-radius:15px;
      backdrop-filter: blur(10px);
    }
    h1 { font-size:2em; margin-bottom:8px; font-weight:300; letter-spacing:1px; }
    .location { font-size:0.95em; opacity:0.9; font-weight:300; }
    .last-update { margin-top:8px; font-size:0.9em; opacity:0.85; }
    .status-strip { margin-top:10px; display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; }

    .pill {
      padding:8px 14px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.14);
      font-weight:600;
      font-size:0.95em;
      min-width:90px;
      text-align:center;
    }
    .pill.ok { border-color: rgba(76,175,80,0.75); color: #fff; background: rgba(76,175,80,0.06); }
    .pill.warn { border-color: rgba(255,152,0,0.8); color: #fff; background: rgba(255,152,0,0.06); }
    .pill.bad { border-color: rgba(244,67,54,0.9); color: #fff; background: rgba(244,67,54,0.06); }

    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:15px; margin-bottom:20px; }
    .card { background: rgba(255,255,255,0.12); padding:18px; border-radius:14px; border:1px solid rgba(255,255,255,0.12); backdrop-filter: blur(6px); }
    .card-title { font-size:0.85em; text-transform:uppercase; opacity:0.85; margin-bottom:12px; font-weight:600; letter-spacing:1px; }

    .current-temp { font-size:3.2em; font-weight:200; line-height:1; }
    .temp-unit { font-size:0.45em; opacity:0.8; }

    .tide-panel { background: linear-gradient(135deg,#0277bd 0%,#01579b 100%); border:2px solid rgba(255,255,255,0.18); }
    .tide-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px; }
    .tide-item { text-align:center; padding:14px; background: rgba(255,255,255,0.08); border-radius:10px; }
    .tide-item.current { background: rgba(255,152,0,0.22); border:2px solid rgba(255,152,0,0.38); }

    .chart-container { position:relative; height:250px; margin-top:12px; }
    .wide-card { grid-column:1 / -1; }

    @media (max-width:768px) {
      h1 { font-size:1.6em; }
      .current-temp { font-size:2.6em; }
      .tide-grid { grid-template-columns: 1fr; }
      .chart-container { height:220px; }
    }
    @supports (-webkit-touch-callout:none) {
      body { padding-top: calc(env(safe-area-inset-top) + 10px); padding-bottom: calc(env(safe-area-inset-bottom) + 10px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>âš“ Wyman Cove Weather</h1>
      <div class="location" id="location">Loading...</div>
      <div class="last-update" id="lastUpdate">Last Updated: --</div>
      <div class="status-strip" id="statusStrip"></div>
    </header>

    <div id="alertsContainer"></div>

    <div class="grid">
      <div class="card">
        <div class="card-title">Current Conditions</div>
        <div id="currentTemp" class="current-temp">--<span class="temp-unit">Â°F</span></div>
        <div id="feelsLike" style="opacity:0.9; margin-top:8px;">Feels like --Â°F</div>
        <div id="condition" style="margin-top:12px; font-size:1.1em; font-weight:300;">Loading...</div>
        <div id="currentNote" style="margin-top:10px; font-size:0.9em; opacity:0.85;"></div>
      </div>

      <div class="card tide-panel">
        <div class="card-title">ğŸŒŠ Tides Today - Salem</div>
        <div class="tide-grid" id="tideGrid">
          <div class="tide-item">
            <div class="tide-type">Loading...</div>
            <div class="tide-time">--</div>
            <div class="tide-height">-- ft</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-title">ğŸ  Hyperlocal Comparison</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:6px;">
          <div style="padding:12px; background:rgba(255,255,255,0.06); border-radius:8px;">
            <div style="opacity:0.85; font-size:0.9em;">Model</div>
            <div id="modelTemp" style="font-size:1.5em; font-weight:700; margin-top:6px;">--Â°F</div>
          </div>
          <div style="padding:12px; background:rgba(255,255,255,0.06); border-radius:8px;">
            <div style="opacity:0.85; font-size:0.9em;">Castle Hill</div>
            <div id="pwsTemp" style="font-size:1.5em; font-weight:700; margin-top:6px;">--Â°F</div>
          </div>
        </div>
        <div style="margin-top:12px; text-align:center; font-size:0.95em; opacity:0.85;">Diff: <span id="tempDiff">--</span></div>
        <div id="hyperlocalNote" style="margin-top:10px; font-size:0.9em; opacity:0.85;"></div>
      </div>

      <div class="card">
        <div class="card-title">Today's Summary</div>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <div style="display:flex; justify-content:space-between;"><div style="opacity:0.85;">High</div><div id="high" style="font-weight:700;">--Â°F</div></div>
          <div style="display:flex; justify-content:space-between;"><div style="opacity:0.85;">Low</div><div id="low" style="font-weight:700;">--Â°F</div></div>
          <div style="display:flex; justify-content:space-between;"><div style="opacity:0.85;">Precipitation</div><div id="precipChance" style="font-weight:700;">--%</div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Wind & Pressure</div>
        <div id="windMetrics"></div>
        <div id="pressureTrendNote" style="margin-top:8px; font-size:0.9em; opacity:0.85;"></div>
      </div>

      <div class="card">
        <div class="card-title">Almanac</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div style="text-align:center;">
            <div style="opacity:0.85;">ğŸŒ… Sunrise</div>
            <div id="sunrise" style="font-weight:700; margin-top:6px;">--</div>
          </div>
          <div style="text-align:center;">
            <div style="opacity:0.85;">ğŸŒ‡ Sunset</div>
            <div id="sunset" style="font-weight:700; margin-top:6px;">--</div>
          </div>
        </div>
        <div id="daylightInfo" style="margin-top:12px; text-align:center; opacity:0.9;"></div>
      </div>
    </div>

    <div class="card wide-card">
      <div class="card-title">10-Day Forecast</div>
      <div class="grid" id="forecastGrid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-top:10px;"></div>
    </div>

    <div class="card wide-card">
      <div class="card-title">48-Hour Temperature & Precipitation</div>
      <div class="chart-container"><canvas id="hourlyChart"></canvas></div>
    </div>

    <div class="card wide-card">
      <div class="card-title">48-Hour Wind Forecast</div>
      <div class="chart-container"><canvas id="windChart"></canvas></div>
    </div>
  </div>

  <script>
    // small helpers
    function windDirection(deg) {
      if (typeof deg !== 'number') return '--';
      const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      return dirs[Math.round(deg / 22.5) % 16];
    }

    function formatTime(isoString) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return '--';
      return d.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
    }

    function formatHour(isoString, idx, all) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return '--';
      const hour = d.toLocaleTimeString('en-US', { hour:'numeric' });
      if (idx > 0 && all && all[idx-1]) {
        const prev = new Date(all[idx-1]);
        if (!isNaN(prev.getTime()) && d.getDate() !== prev.getDate()) {
          return d.toLocaleDateString('en-US', { weekday:'short' }) + ' ' + hour;
        }
      }
      return hour;
    }

    // emoji/desc mappings
    const weatherEmoji = { 0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",51:"ğŸŒ¦ï¸",53:"ğŸŒ§ï¸",55:"ğŸŒ§ï¸",61:"ğŸŒ§ï¸",63:"ğŸŒ§ï¸",65:"ğŸŒ§ï¸",71:"ğŸŒ¨ï¸",73:"ğŸŒ¨ï¸",75:"ğŸŒ¨ï¸",77:"ğŸŒ¨ï¸",80:"ğŸŒ¦ï¸",81:"ğŸŒ¦ï¸",82:"ğŸŒ§ï¸",85:"ğŸŒ¨ï¸",86:"ğŸŒ¨ï¸",95:"â›ˆï¸",96:"â›ˆï¸",99:"â›ˆï¸" };
    const weatherDesc = { 0:"Clear",1:"Mostly Clear",2:"Partly Cloudy",3:"Overcast",45:"Fog",48:"Freezing Fog",51:"Light Drizzle",53:"Drizzle",55:"Heavy Drizzle",61:"Light Rain",63:"Rain",65:"Heavy Rain",71:"Light Snow",73:"Snow",75:"Heavy Snow",77:"Snow Grains",80:"Light Showers",81:"Showers",82:"Heavy Showers",85:"Light Snow Showers",86:"Snow Showers",95:"Thunderstorm",96:"Thunderstorm with Hail",99:"Severe Thunderstorm" };

    // pill class logic (green <30m, yellow 30-59m, red 60m+ or failure)
    function pillClassFromSource(meta) {
      if (!meta) return "pill bad";
      const status = meta.status || "error";
      const age = meta.age_minutes;

      if (status !== "ok") return "pill bad";
      if (typeof age === "number") {
        if (age >= 60) return "pill bad";
        if (age >= 30) return "pill warn";
      }
      return "pill ok";
    }

    // show "now" for <1 minute, otherwise round to whole minutes
    function makePill(label, meta) {
      const cls = pillClassFromSource(meta);
      const status = meta?.status || "error";
      const ageNum = meta?.age_minutes;

      let ageText = "--";
      if (typeof ageNum === "number") {
        if (ageNum < 1) ageText = "now";
        else ageText = Math.round(ageNum) + "m";
      }

      const txt = (status === "ok") ? `${label}: ${ageText}` : `${label}: offline`;
      return `<div class="${cls}">${txt}</div>`;
    }

    // fetch and render JSON
    fetch('weather_data.json?t=' + Date.now())
      .then(r => r.json())
      .then(data => {
        // header location
        document.getElementById('location').textContent = data?.location?.name || 'Wyman Cove';

        // ---------- Live header "Updated: ... (X ago)" ----------
        (function () {
          const updatedStr = data?.generated_at || data?.location?.updated;
          const el = document.getElementById('lastUpdate');

          if (!updatedStr) {
            el.textContent = 'Updated: --';
            return;
          }

          const updatedDate = new Date(updatedStr);
          const humanTs = updatedDate.toLocaleDateString('en-US', { month:'short', day:'numeric' }) + ' ' +
                          updatedDate.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });

          // backend-provided baseline age (prefer model/source age)
          const backendAge = (typeof data?.sources?.open_meteo?.age_minutes === 'number') ? data.sources.open_meteo.age_minutes :
                              (typeof data?.location?.age_minutes === 'number' ? data.location.age_minutes : null);

          const generatedAtMs = updatedDate.getTime();
          const fetchMs = Date.now();

          function currentAgeMinutes() {
            const elapsedSinceFetchMin = (Date.now() - fetchMs) / 60000.0;
            if (typeof backendAge === 'number') return backendAge + elapsedSinceFetchMin;
            return (Date.now() - generatedAtMs) / 60000.0;
          }

          function ageTextFromMinutes(ageMin) {
            if (typeof ageMin !== 'number' || isNaN(ageMin)) return null;
            if (ageMin < 1) return 'now';
            return `${Math.round(ageMin)}m ago`;
          }

          function setHeaderText(ageText) {
            if (ageText) el.textContent = `Updated: ${humanTs} (${ageText})`;
            else el.textContent = `Updated: ${humanTs}`;
          }

          setHeaderText(ageTextFromMinutes(currentAgeMinutes()));
          const headerTimer = setInterval(() => { setHeaderText(ageTextFromMinutes(currentAgeMinutes())); }, 60000);
          // store in case needed: window._weather_header_timer = headerTimer;
        })();

        // status strip initial rendering using source metadata
        const sourcesMeta = data?.sources || {};
        document.getElementById('statusStrip').innerHTML =
          makePill("Model", sourcesMeta.open_meteo) +
          makePill("PWS", sourcesMeta.pws) +
          makePill("Tides", sourcesMeta.tides) +
          makePill("Alerts", sourcesMeta.nws_alerts);

        // Alerts
        if (Array.isArray(data?.alerts) && data.alerts.length > 0) {
          const alertsHTML = data.alerts.map(alert => `
            <a href="${alert.url || '#'}" target="_blank" style="text-decoration:none;color:inherit;display:block;">
              <div class="card" style="margin-bottom:8px; background:linear-gradient(135deg,#d32f2f 0%,#c62828 100%);">
                <div style="font-weight:700;">âš ï¸ ${alert.event || 'Alert'}</div>
                <div style="opacity:0.9; margin-top:6px;">${alert.headline || alert.description || ''}</div>
              </div>
            </a>
          `).join('');
          document.getElementById('alertsContainer').innerHTML = alertsHTML;
        } else {
          document.getElementById('alertsContainer').innerHTML = '';
        }

        // Current
        const curr = data?.current || {};
        if (typeof curr.temperature === 'number') {
          document.getElementById('currentTemp').innerHTML = curr.temperature.toFixed(1) + '<span class="temp-unit">Â°F</span>';
          document.getElementById('feelsLike').textContent = (typeof curr.feels_like === 'number') ? `Feels like ${curr.feels_like.toFixed(1)}Â°F` : 'Feels like --Â°F';
          document.getElementById('condition').textContent = (curr.emoji || '') + ' ' + (curr.condition || '');
        } else {
          document.getElementById('currentTemp').innerHTML = '--<span class="temp-unit">Â°F</span>';
          document.getElementById('feelsLike').textContent = 'Feels like --Â°F';
          document.getElementById('condition').textContent = 'Model offline';
        }

        // Tides
        if (Array.isArray(data?.tides) && data.tides.length > 0) {
          const nextIdx = (function(tides){
            const now = new Date();
            const curMins = now.getHours()*60 + now.getMinutes();
            for (let i=0;i<tides.length;i++){
              const p = (tides[i].time||'').split(':').map(Number);
              if (p.length===2 && (p[0]*60+p[1])>curMins) return i;
            }
            return null;
          })(data.tides);

          const tidesHTML = data.tides.map((t,i) => {
            const isCurrent = i===nextIdx;
            const parts = (t.time||'--:--').split(':');
            const hh = parseInt(parts[0]||'0',10); const mm = parts[1]||'00';
            const ampm = hh >= 12 ? 'PM' : 'AM'; const displayHour = hh%12 || 12;
            const height = (typeof t.height === 'number') ? t.height.toFixed(1) : '--';
            return `<div class="tide-item ${isCurrent ? 'current' : ''}"><div class="tide-type">${t.type==='H' ? 'â¬†ï¸ High' : 'â¬‡ï¸ Low'}</div><div class="tide-time">${displayHour}:${mm} ${ampm}</div><div class="tide-height">${height} ft</div></div>`;
          }).join('');
          document.getElementById('tideGrid').innerHTML = tidesHTML;

          // countdown to next tide (first future)
          const now = new Date(); const today = now.toISOString().split('T')[0];
          for (let t of data.tides) {
            const parts = (t.time||'').split(':');
            if (parts.length !== 2) continue;
            const tideDate = new Date(`${today}T${parts[0].padStart(2,'0')}:${parts[1].padStart(2,'0')}:00`);
            if (tideDate > now) {
              const diffMs = tideDate - now; const hrs = Math.floor(diffMs/3600000); const mins = Math.floor((diffMs%3600000)/60000);
              const countdown = (hrs>0)? `${hrs}h ${mins}m` : `${mins}m`;
              const div = document.createElement('div'); div.style.cssText = 'text-align:center;margin-top:12px;font-size:0.95em;opacity:0.9;'; div.textContent = `Next ${t.type==='H' ? 'high' : 'low'} tide in ${countdown}`;
              document.querySelector('.tide-panel').appendChild(div);
              break;
            }
          }
        }

        // PWS & Model comparison
        const pws = data?.pws || {};
        if (typeof pws.temperature === 'number') document.getElementById('pwsTemp').textContent = pws.temperature.toFixed(1) + 'Â°F';
        else document.getElementById('pwsTemp').textContent = 'N/A';
        if (typeof curr.temperature === 'number') document.getElementById('modelTemp').textContent = curr.temperature.toFixed(1) + 'Â°F';
        else document.getElementById('modelTemp').textContent = 'N/A';

        if (typeof pws.temperature === 'number' && typeof curr.temperature === 'number') {
          document.getElementById('tempDiff').textContent = Math.abs(pws.temperature - curr.temperature).toFixed(1) + 'Â°F';
        } else { document.getElementById('tempDiff').textContent = '--'; }

        if (pws.stale) document.getElementById('hyperlocalNote').textContent = 'Note: PWS value is cached (scrape failed).';
        else document.getElementById('hyperlocalNote').textContent = '';

        // Today's summary
        const daily = data?.daily || {};
        if (Array.isArray(daily.temperature_max) && daily.temperature_max.length > 0) {
          document.getElementById('high').textContent = Math.round(daily.temperature_max[0]) + 'Â°F';
          document.getElementById('low').textContent = Math.round(daily.temperature_min[0]) + 'Â°F';
          document.getElementById('precipChance').textContent = Math.round(daily.precipitation_probability_max?.[0] || 0) + '%';
        }

        // Wind & pressure
        if (typeof curr.temperature === 'number') {
          const pressureInHg = (typeof curr.pressure === 'number') ? (curr.pressure / 33.864).toFixed(2) : '--';
          document.getElementById('windMetrics').innerHTML = `
            <div style="display:flex;justify-content:space-between;"><div style="opacity:0.85;">Wind</div><div style="font-weight:700">${windDirection(curr.wind_direction)} ${Math.round(curr.wind_speed||0)} mph</div></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px;"><div style="opacity:0.85;">Gusts</div><div style="font-weight:700">${Math.round(curr.wind_gusts||0)} mph</div></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px;"><div style="opacity:0.85;">Pressure</div><div style="font-weight:700">${pressureInHg} inHg</div></div>
          `;
        } else {
          document.getElementById('windMetrics').innerHTML = `<div style="opacity:0.85;">Wind: --</div>`;
        }

        if (data?.derived?.pressure_trend) {
          document.getElementById('pressureTrendNote').textContent = `Pressure trend: ${data.derived.pressure_trend}`;
        } else {
          document.getElementById('pressureTrendNote').textContent = '';
        }

        // Almanac
        if (Array.isArray(daily.sunrise) && daily.sunrise[0]) {
          document.getElementById('sunrise').textContent = formatTime(daily.sunrise[0]);
          document.getElementById('sunset').textContent = formatTime(daily.sunset[0]);
          const rise = new Date(daily.sunrise[0]); const set = new Date(daily.sunset[0]);
          if (!isNaN(rise.getTime()) && !isNaN(set.getTime())) {
            const daylightH = Math.floor((set - rise)/3600000);
            const daylightM = Math.round((((set-rise)/3600000) - daylightH) * 60);
            document.getElementById('daylightInfo').textContent = `Daylight: ${daylightH}h ${daylightM}m`;

            // sailing window
            const sailingTime = (function() {
              const diff = set - new Date();
              if (diff <= 0) return null;
              const hrs = Math.floor(diff/3600000);
              const mins = Math.floor((diff%3600000)/60000);
              return hrs>0 ? `${hrs}h ${mins}m` : `${mins}m`;
            })();
            if (sailingTime) {
              const parent = document.getElementById('daylightInfo').parentElement;
              const old = document.getElementById('sailingNote'); if (old) old.remove();
              const d = document.createElement('div'); d.id = 'sailingNote'; d.style.cssText = 'margin-top:12px;padding:10px;background:rgba(255,152,0,0.12);border-radius:8px;text-align:center;font-weight:600;'; d.textContent = `â›µ ${sailingTime} of sailing light`; parent.appendChild(d);
            }
          }
        }

        // 10-day forecast
        if (Array.isArray(daily.dates) && daily.dates.length > 0) {
          const forecastHTML = daily.dates.map((date, i) => {
            const dayName = i===0 ? 'Today' : new Date(date).toLocaleDateString('en-US', { weekday:'short' });
            const code = daily.weather_code?.[i]; const emoji = weatherEmoji[code] || 'ğŸŒ¡ï¸';
            return `<div class="forecast-day" style="text-align:center;padding:12px;background:rgba(255,255,255,0.06);border-radius:8px;">
              <div style="font-weight:700;margin-bottom:6px;">${dayName}</div>
              <div style="font-size:1.8em;">${emoji}</div>
              <div style="margin-top:8px;"><strong>${Math.round(daily.temperature_max?.[i]||0)}Â°</strong> <span style="opacity:0.8">${Math.round(daily.temperature_min?.[i]||0)}Â°</span></div>
              <div style="opacity:0.85;margin-top:6px;">${Math.round(daily.precipitation_probability_max?.[i]||0)}%</div>
            </div>`;
          }).join('');
          document.getElementById('forecastGrid').innerHTML = forecastHTML;
        }

        // Charts
        const hourly = data?.hourly || {};
        if (Array.isArray(hourly.times) && hourly.times.length > 0) {
          const labels = hourly.times.map((t,i) => formatHour(t,i,hourly.times));
          // hourly chart
          const ctx = document.getElementById('hourlyChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                { label:'Temp Â°F', data: hourly.temperature || [], borderColor:'#ff9800', backgroundColor:'rgba(255,152,0,0.08)', yAxisID:'y', tension:0.4, pointRadius:2, borderWidth:2 },
                { label:'Precip %', data: hourly.precipitation_probability || [], borderColor:'#2196F3', backgroundColor:'rgba(33,150,243,0.12)', fill:true, yAxisID:'y1', tension:0.4, pointRadius:0, borderWidth:2 }
              ]
            },
            options: {
              responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false},
              plugins:{ legend:{ labels:{ color:'#fff', font:{ size:11 } } } },
              scales:{ y:{ ticks:{ color:'#fff', font:{ size:10 } }, grid:{ color:'rgba(255,255,255,0.08)' } }, y1:{ position:'right', ticks:{ color:'#fff', font:{ size:10 } }, grid:{ drawOnChartArea:false }, max:100, min:0 }, x:{ ticks:{ color:'#fff', font:{ size:10 } }, grid:{ color:'rgba(255,255,255,0.05)' } } }
            }
          });

          // wind chart
          const ctx2 = document.getElementById('windChart').getContext('2d');
          new Chart(ctx2, {
            type: 'line',
            data: {
              labels,
              datasets: [
                { label:'Wind mph', data: hourly.wind_speed || [], borderColor:'#4CAF50', backgroundColor:'rgba(76,175,80,0.08)', tension:0.4, pointRadius:2, borderWidth:2 },
                { label:'Gusts mph', data: hourly.wind_gusts || [], borderColor:'#F44336', backgroundColor:'rgba(244,67,54,0.08)', tension:0.4, pointRadius:2, borderWidth:2, borderDash:[5,5] }
              ]
            },
            options: {
              responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false},
              plugins:{ legend:{ labels:{ color:'#fff', font:{ size:11 } } } },
              scales:{ y:{ ticks:{ color:'#fff', font:{ size:10 } }, grid:{ color:'rgba(255,255,255,0.08)' } }, x:{ ticks:{ color:'#fff', font:{ size:10 } }, grid:{ color:'rgba(255,255,255,0.05)' } } }
            }
          });
        }

        // --- LIVE AGE REFRESH (update pills every minute) ---
        // record fetch time and use backend ages as baselines
        const fetchTime = Date.now();
        const sources = data?.sources || {};

        function rebuildStatusStripWithAdjustedAges(elapsedMinutes) {
          const s = sources;
          const open_meteo_meta = s.open_meteo ? { ...s.open_meteo, age_minutes: (typeof s.open_meteo.age_minutes === 'number' ? s.open_meteo.age_minutes + elapsedMinutes : undefined) } : null;
          const pws_meta        = s.pws        ? { ...s.pws,        age_minutes: (typeof s.pws.age_minutes        === 'number' ? s.pws.age_minutes        + elapsedMinutes : undefined) } : null;
          const tides_meta      = s.tides      ? { ...s.tides,      age_minutes: (typeof s.tides.age_minutes      === 'number' ? s.tides.age_minutes      + elapsedMinutes : undefined) } : null;
          const alerts_meta     = s.nws_alerts ? { ...s.nws_alerts, age_minutes: (typeof s.nws_alerts.age_minutes === 'number' ? s.nws_alerts.age_minutes + elapsedMinutes : undefined) } : null;

          document.getElementById('statusStrip').innerHTML =
            makePill("Model", open_meteo_meta) +
            makePill("PWS", pws_meta) +
            makePill("Tides", tides_meta) +
            makePill("Alerts", alerts_meta);
        }

        // run immediately and then every minute
        rebuildStatusStripWithAdjustedAges(0);
        const liveAgeTimer = setInterval(() => {
          const elapsedMinutes = (Date.now() - fetchTime) / 60000.0;
          rebuildStatusStripWithAdjustedAges(elapsedMinutes);
        }, 60000);

      }) // end .then
      .catch(err => {
        console.error('Error loading weather_data.json', err);
        document.getElementById('location').textContent = 'Error loading data';
        document.getElementById('lastUpdate').textContent = '';
        document.getElementById('statusStrip').innerHTML = '<div class="pill bad">Data load failed</div>';
      });
  </script>
</body>
</html>
