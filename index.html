<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- iOS Web App Config -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Wyman Cove" />

  <title>Wyman Cove Weather</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255, 255, 255, 0.06);
      --card2: rgba(255, 255, 255, 0.09);
      --border: rgba(255, 255, 255, 0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --muted2: rgba(255,255,255,0.55);
      --accent: rgba(255,255,255,0.18);
      --shadow: 0 10px 28px rgba(0,0,0,0.35);
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(84, 150, 255, 0.25), transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, rgba(90, 255, 190, 0.12), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 16px 14px 28px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px 14px 12px;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,0.05);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    header h1 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: 0.2px;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .version-pill{
      font-size: 0.78rem;
      font-weight: 800;
      color: rgba(255,255,255,0.78);
      border: 1px solid rgba(255,255,255,0.18);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      white-space: nowrap;
    }

    .meta-row{
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .meta-item{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
    }

    .meta-label{
      color: rgba(255,255,255,0.55);
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .meta-value{
      color: rgba(255,255,255,0.86);
      font-weight: 800;
    }

    .source-row{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .source-pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      font-size: 0.82rem;
      font-weight: 800;
      color: rgba(255,255,255,0.86);
    }
    .source-pill .small{
      font-weight: 800;
      color: rgba(255,255,255,0.65);
    }

    .tabs{
      margin-top: 6px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .tab{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      transition: transform 0.06s ease, background 0.15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .tab:active{ transform: scale(0.98); }
    .tab.active{
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.28);
    }

    .grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .card{
      grid-column: span 6;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .card.col-12{ grid-column: span 12; }
    .card.col-6{ grid-column: span 6; }

    .card-title{
      font-weight: 900;
      color: rgba(255,255,255,0.88);
      font-size: 0.95rem;
      letter-spacing: 0.2px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }

    .small-note{
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
      line-height: 1.2rem;
      margin-top: 8px;
    }

    .current-temp{
      font-size: 3rem;
      font-weight: 1000;
      letter-spacing: -1px;
      margin-top: 8px;
    }

    .temp-unit{
      font-size: 1.25rem;
      font-weight: 900;
      color: rgba(255,255,255,0.7);
      margin-left: 6px;
    }

    .feels-like{
      margin-top: 2px;
      font-size: 1rem;
      color: rgba(255,255,255,0.76);
      font-weight: 800;
    }

    .condition{
      margin-top: 10px;
      font-size: 1.05rem;
      font-weight: 900;
      color: rgba(255,255,255,0.86);
    }

    .row{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 7px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 0.95rem;
    }
    .row:last-child{ border-bottom: none; }

    .label{
      color: rgba(255,255,255,0.62);
      font-weight: 800;
    }
    .value{
      color: rgba(255,255,255,0.9);
      font-weight: 900;
      text-align: right;
      white-space: nowrap;
    }

    .alert-banner{
      background: rgba(255, 80, 80, 0.18);
      border: 1px solid rgba(255, 80, 80, 0.30);
      border-radius: 16px;
      padding: 12px 14px;
      margin-top: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .alert-title{ font-weight: 1000; }
    .alert-desc{ color: rgba(255,255,255,0.78); margin-top: 4px; }

    .tide-grid{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .tide-item{
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.05);
    }
    .tide-item .tide-type{
      font-weight: 1000;
      color: rgba(255,255,255,0.85);
      margin-bottom: 2px;
    }
    .tide-item .tide-time{
      font-weight: 900;
      color: rgba(255,255,255,0.78);
    }
    .tide-item .tide-height{
      font-weight: 900;
      color: rgba(255,255,255,0.72);
      font-size: 0.9rem;
    }

    canvas{
      width: 100% !important;
      height: 220px !important;
    }

    @media (max-width: 780px){
      .card{ grid-column: span 12; }
      canvas{ height: 240px !important; }
      header{ position: relative; top: 0; }
    }
    /* --- iOS Chart Fix --- */
    canvas {
    display: block;  
    }

    #windChart {
    width: 100% !important;
    height: 220px !important;
    }

    /* Make 48-hour charts less ‚Äústretched‚Äù on wide screens */
  @media (min-width: 900px) {
  #tempPrecipChart, #windChart {
    height: 420px !important;
  }
}

/* Also helps iPhone landscape / tablet landscape */
@media (orientation: landscape) and (max-width: 900px) {
  #tempPrecipChart, #windChart {
    height: 260px !important;
  }
}
  /* --- Wind Risk tiles --- */
.risk-tiles{
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin: 12px 0 14px 0;
}

@media (max-width: 780px){
  .risk-tiles{
    grid-template-columns: repeat(2, 1fr);
  }
}

.risk-tile{
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.04);
  border-radius: 16px;
  padding: 12px 12px 10px 12px;
}

.risk-tile .kicker{
  font-weight: 700;
  opacity: 0.85;
  margin-bottom: 6px;
}

.risk-tile .big{
  font-size: 22px;
  font-weight: 800;
  line-height: 1.05;
  margin-bottom: 4px;
}

.risk-tile .sub{
  font-size: 13px;
  opacity: 0.7;
}

/* Risk badge colors */
.badge{
  display: inline-block;
  padding: 3px 9px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
  margin-left: 6px;
  border: 1px solid rgba(255,255,255,0.15);
}

.badge.low    { background: rgba(160,160,160,0.18); }
.badge.mod    { background: rgba(255,170,0,0.22); }
.badge.high   { background: rgba(255,80,80,0.25); }
.badge.severe { background: rgba(200,60,255,0.25); }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>
        ‚öì Wyman Cove Weather
        <span class="version-pill" id="appVersion">v1.2</span>
      </h1>

      <div class="meta-row">
        <div class="meta-item">
          <span class="meta-label">Location</span>
          <span class="meta-value" id="location">Loading‚Ä¶</span>
        </div>

        <div class="meta-item">
          <span class="meta-label">Data generated</span>
          <span class="meta-value" id="dataUpdated">--</span>
        </div>

        <div class="meta-item">
          <span class="meta-label">Page loaded</span>
          <span class="meta-value" id="pageLoaded">--</span>
        </div>
      </div>

      <div class="source-row" id="sourceRow"></div>

      <nav class="tabs" role="tablist" aria-label="Views">
        <button class="tab active" id="tabHome" role="tab" aria-selected="true" onclick="showTab('home')">Home</button>
        <button class="tab" id="tabWind" role="tab" aria-selected="false" onclick="showTab('wind')">Wind</button>
      </nav>
    </header>

    <div id="alertsContainer"></div>

    <!-- HOME VIEW -->
    <section id="homeView">
      <div class="grid">
        <!-- Current Conditions -->
        <div class="card col-6">
          <div class="card-title">Current Conditions</div>
          <div id="currentTemp" class="current-temp">--<span class="temp-unit">¬∞F</span></div>
          <div id="feelsLike" class="feels-like">Feels like --¬∞F</div>
          <div id="condition" class="condition">Loading‚Ä¶</div>
        </div>

        <!-- TIDE PANEL -->
        <div class="card col-6">
          <div class="card-title">üåä Tides Today ‚Äî Salem</div>
          <div class="tide-grid" id="tideGrid"></div>
          <div class="small-note" id="nextTideNote"></div>
        </div>

        <!-- Hyperlocal Comparison -->
        <div class="card col-6">
          <div class="card-title">üè† Hyperlocal Comparison</div>
          <div class="row">
            <div class="label">Model Temp</div>
            <div class="value" id="modelTemp">--¬∞F</div>
          </div>
          <div class="row">
            <div class="label">PWS Temp</div>
            <div class="value" id="pwsTemp">--¬∞F</div>
          </div>
          <div class="row">
            <div class="label">Bias</div>
            <div class="value" id="tempBias">--¬∞F</div>
          </div>
          <div class="row">
            <div class="label">Corrected</div>
            <div class="value" id="correctedTemp">--¬∞F</div>
          </div>
          <div class="small-note" id="pwsNote"></div>
        </div>

        <!-- Today's Summary -->
        <div class="card col-6">
          <div class="card-title">Today‚Äôs Summary</div>
          <div class="row">
            <div class="label">High / Low</div>
            <div class="value" id="hiLo">-- / --</div>
          </div>
          <div class="row">
            <div class="label">Precip Chance</div>
            <div class="value" id="precipChance">--%</div>
          </div>
          <div class="row">
            <div class="label">Wind (now)</div>
            <div class="value" id="windNowHome">--</div>
          </div>
          <div class="row">
            <div class="label">Pressure Trend (2h)</div>
            <div class="value" id="pressureTrendHome">--</div>
          </div>
          <div class="small-note" id="todayNote"></div>
        </div>

        <!-- Almanac -->
        <div class="card col-6">
          <div class="card-title">Almanac</div>
          <div class="row">
            <div class="label">Sunrise</div>
            <div class="value" id="sunrise">--</div>
          </div>
          <div class="row">
            <div class="label">Sunset</div>
            <div class="value" id="sunset">--</div>
          </div>
        </div>

        <!-- 10-Day Forecast -->
        <div class="card col-6">
          <div class="card-title">10-Day Forecast</div>
          <div id="forecastList"></div>
        </div>

        <!-- 48-Hour Temperature & Precipitation -->
        <div class="card col-12">
          <div class="card-title">48-Hour Temperature & Precipitation</div>
          <canvas id="tempPrecipChart"></canvas>
        </div>
      </div>
    </section>

    <!-- WIND VIEW -->
    <section id="windView" style="display:none;">
      <div class="grid">
        <!-- Wind Risk -->
        <div class="card col-12">
         <div class="card-title">üå¨ Wind Risk 
    <select id="riskWindowSelect">
      <option value="12">12h</option>
      <option value="24">24h</option>
      <option value="36">36h</option>
      <option value="48">48h</option>
    </select>
    <div class="row">
    <div class="label">Risk Level</div>
    <div class="value" id="windRiskLevel">--</div>
    </div>

    <div class="row">
    <div class="label">Peak Gust</div>
    <div class="value" id="windRiskPeak">-- mph</div>
    </div>

    <div class="row">
    <div class="label">Direction</div>
    <div class="value" id="windRiskDir">--</div>
    </div>

    <div class="row">
    <div class="label">Peak Time</div>
    <div class="value" id="windRiskTime">--</div>
    </div>

      <div class="small-note" id="windRiskNote"></div>
      </div>
      </div>

        <!-- Wind & Pressure -->
        <div class="card col-12">
          <div class="card-title">Wind & Pressure (now)</div>
          <div class="row">
            <div class="label">Wind</div>
            <div class="value" id="windNowWind">--</div>
          </div>
          <div class="row">
            <div class="label">Gusts</div>
            <div class="value" id="windGustsWind">--</div>
          </div>
          <div class="row">
            <div class="label">Pressure</div>
            <div class="value" id="pressureNowWind">--</div>
          </div>
          <div class="row">
            <div class="label">Trend (2h)</div>
            <div class="value" id="pressureTrendWind">--</div>
          </div>
          <div class="small-note" id="windPressureNote"></div>
        </div>

        <!-- 48-Hour Wind Forecast -->
        <div class="card col-12">
          <div class="card-title">48-Hour Wind Forecast</div>
          <canvas id="windChart"></canvas>
        </div>
      </div>
    </section>
  </div>

  <script>
    // -------- Tab behavior --------
    function showTab(which){
      const home = document.getElementById("homeView");
      const wind = document.getElementById("windView");
      const tabHome = document.getElementById("tabHome");
      const tabWind = document.getElementById("tabWind");

      const isWind = (which === "wind");
      home.style.display = isWind ? "none" : "";
      wind.style.display = isWind ? "" : "none";

      tabHome.classList.toggle("active", !isWind);
      tabWind.classList.toggle("active", isWind);

      tabHome.setAttribute("aria-selected", String(!isWind));
      tabWind.setAttribute("aria-selected", String(isWind));

      try { localStorage.setItem("activeTab", which); } catch(e) {}
    }

    (function restoreTab(){
      try {
        const t = localStorage.getItem("activeTab");
        if (t === "wind") showTab("wind");
      } catch(e) {}
    })();

    // -------- Formatting helpers --------
    const weatherEmoji = {
      0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "‚òÅÔ∏è",
      45: "üå´Ô∏è", 48: "üå´Ô∏è",
      51: "üå¶Ô∏è", 53: "üåßÔ∏è", 55: "üåßÔ∏è",
      61: "üåßÔ∏è", 63: "üåßÔ∏è", 65: "üåßÔ∏è",
      71: "üå®Ô∏è", 73: "üå®Ô∏è", 75: "üå®Ô∏è",
      77: "üå®Ô∏è", 80: "üå¶Ô∏è", 81: "üå¶Ô∏è", 82: "üåßÔ∏è",
      85: "üå®Ô∏è", 86: "üå®Ô∏è",
      95: "‚õàÔ∏è", 96: "‚õàÔ∏è", 99: "‚õàÔ∏è"
    };

    const weatherDesc = {
      0: "Clear", 1: "Mostly Clear", 2: "Partly Cloudy", 3: "Overcast",
      45: "Fog", 48: "Freezing Fog",
      51: "Light Drizzle", 53: "Drizzle", 55: "Heavy Drizzle",
      61: "Light Rain", 63: "Rain", 65: "Heavy Rain",
      71: "Light Snow", 73: "Snow", 75: "Heavy Snow",
      77: "Snow Grains", 80: "Light Showers", 81: "Showers", 82: "Heavy Showers",
      85: "Light Snow Showers", 86: "Heavy Snow Showers",
      95: "Thunderstorm", 96: "Thunderstorm + Hail", 99: "Severe Thunderstorm"
    };

    function fmtLocal(dt){
      if (!dt) return "--";
      const d = new Date(dt);
      if (isNaN(d.getTime())) return "--";
      return d.toLocaleString("en-US", { month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
    }

    function degreesToCompass(deg){
      if (deg === null || deg === undefined) return "--";
      const d = ((deg % 360) + 360) % 360;
      const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      const i = Math.round(d / 22.5) % 16;
      return `${d}¬∞ ${dirs[i]}`;
    }

    // -------- Charts --------
    let tempPrecipChart = null;
    let windChart = null;

    function buildTempPrecipChart(times, temps, pop){
      const labels = times.map(t => new Date(t).toLocaleTimeString("en-US", { hour:"numeric" }));
      const tempData = temps.map(v => (v ?? null));
      const popData = pop.map(v => (v ?? null));

      const ctx = document.getElementById("tempPrecipChart").getContext("2d");
      if (tempPrecipChart) tempPrecipChart.destroy();

      tempPrecipChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Temp (¬∞F)", data: tempData, yAxisID: "y", tension: 0.25 },
            { label: "Precip %", data: popData, yAxisID: "y1", tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "rgba(255,255,255,0.8)" } } },
          scales: {
            x: { ticks: { color: "rgba(255,255,255,0.7)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y: { ticks: { color: "rgba(255,255,255,0.7)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y1: { position: "right", min: 0, max: 100,
              ticks: { color: "rgba(255,255,255,0.7)" },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }
    function degToCompass(deg){
  if (deg == null || isNaN(deg)) return "";
  const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  const i = Math.round(((deg % 360) / 22.5)) % 16;
  return dirs[i];
}

function classifyGust(g){
  if (g >= 55) return { label: "SEV", cls: "severe" };
  if (g >= 45) return { label: "HIGH", cls: "high" };
  if (g >= 35) return { label: "MOD", cls: "mod" };
  return { label: "LOW", cls: "low" };
}

function computePeakInWindow(hourly, windowHours){
  const times = hourly?.times || [];
  const gusts = hourly?.wind_gusts || [];
  const dirs  = hourly?.wind_direction || [];

  const n = Math.min(windowHours, gusts.length);
  let peak = -Infinity;
  let idx = -1;

  for (let i = 0; i < n; i++){
    const g = gusts[i];
    if (g == null) continue;
    if (g > peak){
      peak = g;
      idx = i;
    }
  }

  if (idx < 0) return null;

  return {
    peakGust: gusts[idx],
    timeISO: times[idx],
    directionDeg: dirs[idx]
  };
}
    function buildWindChart(times, speeds, gusts){
      const labels = times.map(t => new Date(t).toLocaleTimeString("en-US", { hour:"numeric" }));
      const sData = speeds.map(v => (v ?? null));
      const gData = gusts.map(v => (v ?? null));

      const ctx = document.getElementById("windChart").getContext("2d");
      if (windChart) windChart.destroy();

      windChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Wind (mph)", data: sData, yAxisID: "y", tension: 0.25 },
            { label: "Gust (mph)", data: gData, yAxisID: "y", tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "rgba(255,255,255,0.8)" } } },
          scales: {
            x: { ticks: { color: "rgba(255,255,255,0.7)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y: { ticks: { color: "rgba(255,255,255,0.7)" }, grid: { color: "rgba(255,255,255,0.06)" } }
          }
        }
      });
    }

    // -------- Rendering --------
    function renderSources(sources){
      const row = document.getElementById("sourceRow");
      if (!row) return;
      row.innerHTML = "";

      if (!sources) return;

      const order = ["open_meteo", "pws", "tides", "nws_alerts"];
      const names = {
        open_meteo: "Model",
        pws: "PWS",
        tides: "Tides",
        nws_alerts: "Alerts"
      };

      order.forEach(key => {
        const s = sources[key];
        if (!s) return;

        const ok = (s.status === "ok");
        const icon = ok ? "‚úÖ" : "‚ùå";
        const age = (typeof s.age_minutes === "number") ? `${s.age_minutes.toFixed(1)}m` : "--";

        const pill = document.createElement("div");
        pill.className = "source-pill";
        pill.innerHTML = `${icon} ${names[key]} <span class="small">(${age})</span>`;
        row.appendChild(pill);
      });
    }

    function renderTides(tides){
      const grid = document.getElementById("tideGrid");
      const note = document.getElementById("nextTideNote");

      grid.innerHTML = "";
      note.textContent = "";

      if (!Array.isArray(tides) || tides.length === 0) {
        note.textContent = "No tide data available.";
        return;
      }

      tides.slice(0,4).forEach(t => {
        const div = document.createElement("div");
        div.className = "tide-item";
        const type = (t.type === "H") ? "High" : "Low";
        div.innerHTML = `
          <div class="tide-type">${type}</div>
          <div class="tide-time">${t.time}</div>
          <div class="tide-height">${(t.height ?? "--")} ft</div>
        `;
        grid.appendChild(div);
      });

      note.textContent = "Dock offsets later ‚Äî this is Salem station for now.";
    }

    function renderForecast(daily){
      const el = document.getElementById("forecastList");
      el.innerHTML = "";

      if (!daily || !Array.isArray(daily.dates)) return;

      for (let i = 0; i < Math.min(10, daily.dates.length); i++){
        const date = new Date(daily.dates[i] + "T00:00:00");
        const day = date.toLocaleDateString("en-US", { weekday:"short" });
        const hi = daily.temperature_max?.[i];
        const lo = daily.temperature_min?.[i];
        const code = daily.weather_code?.[i];
        const emoji = weatherEmoji[code] || "üå°Ô∏è";

        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="label">${day} ${emoji}</div>
          <div class="value">${Math.round(hi)}¬∞ / ${Math.round(lo)}¬∞</div>
        `;
        el.appendChild(row);
      }
    }

    function renderWindRisk(data){
      const levelEl = document.getElementById("windRiskLevel");
      const peakEl  = document.getElementById("windRiskPeak");
      const dirEl   = document.getElementById("windRiskDir");
      const timeEl  = document.getElementById("windRiskTime");
      const noteEl  = document.getElementById("windRiskNote");

      if (!levelEl || !peakEl || !dirEl || !timeEl || !noteEl) return;

      const windowSelect = document.getElementById("riskWindowSelect");
      const hours = parseInt(windowSelect?.value || "12", 10);
      const wpNote = document.getElementById("windPressureNote");
if (wpNote) wpNote.textContent = `Wind Risk uses peak gust in the next ${hours} hours from the model + your exposure multiplier.`;


      const peak = computePeakInWindow(data.hourly, hours);
      if (!peak) {
        levelEl.textContent = "--";
        peakEl.textContent = "-- mph";
        dirEl.textContent = "--";
        timeEl.textContent = "--";
        noteEl.textContent = "No hourly wind data yet.";
        return;
      }

      const risk = classifyGust(peak.peakGust);
      levelEl.textContent = risk.label ?? "--";
      peakEl.textContent = `${Math.round(peak.peakGust)} mph`;
      dirEl.textContent = `${Math.round(peak.directionDeg)}¬∞ ${degToCompass(peak.directionDeg)}`;
      timeEl.textContent = peak.timeISO ? fmtLocal(peak.timeISO) : "--";
      noteEl.textContent = `Peak gust over next ${hours}h (from hourly model).`;
    }

    // -------- Boot: load data --------
    document.getElementById("pageLoaded").textContent =
      new Date().toLocaleString("en-US", { month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });

    fetch("weather_data.json?t=" + Date.now())
      .then(r => r.json())
      .then(data => {
      window.__lastWeatherData = data;  
     
        // Header basics
      document.getElementById("location").textContent = data.location?.name ?? "Wyman Cove";
    

        // Header basics
        document.getElementById("location").textContent = data.location?.name ?? "Wyman Cove";
        document.getElementById("dataUpdated").textContent = fmtLocal(data.generated_at || data.location?.updated);

        renderSources(data.sources);

        // Alerts
        const alertsContainer = document.getElementById("alertsContainer");
        alertsContainer.innerHTML = "";
        if (data.alerts && data.alerts.length > 0){
          alertsContainer.innerHTML = data.alerts.map(alert => `
            <a href="${alert.url}" target="_blank" style="text-decoration:none;color:inherit;display:block;">
              <div class="alert-banner">
                <div class="alert-title">‚ö†Ô∏è ${alert.headline || alert.event || "Weather Alert"}</div>
                <div class="alert-desc">${alert.description || ""}</div>
              </div>
            </a>
          `).join("");
        }

        // Current card
        const cur = data.current || {};
        const curWind = data.current_weather || data.current || {};
        document.getElementById("currentTemp").innerHTML =
          `${Math.round(cur.temperature ?? 0)}<span class="temp-unit">¬∞F</span>`;
        document.getElementById("feelsLike").textContent =
          `Feels like ${Math.round(cur.feels_like ?? 0)}¬∞F`;
        const code = cur.weather_code;
        const emoji = cur.emoji || weatherEmoji[code] || "üå°Ô∏è";
        const desc = cur.condition || weatherDesc[code] || "‚Äî";
        document.getElementById("condition").textContent = `${emoji} ${desc}`;

        // Tides
        renderTides(data.tides);

        // Hyperlocal
        document.getElementById("modelTemp").textContent = (cur.temperature ?? "--") + "¬∞F";
        const pws = data.pws || {};
        document.getElementById("pwsTemp").textContent = (pws.temperature ?? "--") + "¬∞F";
        const hyp = data.hyperlocal || {};
        document.getElementById("tempBias").textContent = (hyp.bias_temp ?? "--") + "¬∞F";
        document.getElementById("correctedTemp").textContent = (hyp.corrected_temp ?? "--") + "¬∞F";
        document.getElementById("pwsNote").textContent =
          pws.stale ? "PWS is stale (cached) ‚Äî using last good reading." : "PWS is fresh.";

        // Today summary
        const daily = data.daily || {};
        const hi = daily.temperature_max?.[0];
        const lo = daily.temperature_min?.[0];
        document.getElementById("hiLo").textContent =
          (hi != null && lo != null) ? `${Math.round(hi)}¬∞ / ${Math.round(lo)}¬∞` : "-- / --";
        const popMax = daily.precipitation_probability_max?.[0];
        document.getElementById("precipChance").textContent =
          (popMax != null) ? `${Math.round(popMax)}%` : "--%";

        const windNowText = (cur.wind_speed != null && cur.wind_direction != null)
          ? `${Math.round(cur.wind_speed)} mph ${degreesToCompass(cur.wind_direction).split(" ").slice(1).join(" ")}`
          : "--";
        document.getElementById("windNowHome").textContent = windNowText;

        const der = data.derived || {};
        const trend = der.pressure_trend ?? "--";
        const delta = (typeof der.pressure_trend_hpa_2h === "number") ? `${der.pressure_trend_hpa_2h.toFixed(1)} hPa/2h` : "";
        document.getElementById("pressureTrendHome").textContent = delta ? `${trend} (${delta})` : trend;
        document.getElementById("todayNote").textContent = cur.time ? `Current time in model: ${cur.time}` : "";

        // Almanac
        document.getElementById("sunrise").textContent = daily.sunrise?.[0]?.split("T")?.[1] ?? "--";
        document.getElementById("sunset").textContent = daily.sunset?.[0]?.split("T")?.[1] ?? "--";

        // Forecast list
        renderForecast(daily);

        // Charts (48h)
        const hourly = data.hourly || {};
        const times = (hourly.times || []).slice(0, 48);
        buildTempPrecipChart(
          times,
          (hourly.temperature || []).slice(0, 48),
          (hourly.precipitation_probability || []).slice(0, 48)
        );
        buildWindChart(
          times,
          (hourly.wind_speed || []).slice(0, 48),
          (hourly.wind_gusts || []).slice(0, 48)
        );
        // renderWindRiskTiles(data.hourly);
        // Wind tab cards
        renderWindRisk(data);

        const riskSel = document.getElementById("riskWindowSelect");
if (riskSel) {
  riskSel.onchange = () => {
    try { renderWindRisk(window.__lastWeatherData || data); }
    catch (e) { console.error("WindRisk onchange failed:", e); }
  };
}

        // Wind tab: current wind + pressure cards (safe even if elements missing)
        const windNowEl = document.getElementById("windNowWind");
        const windGustsEl = document.getElementById("windGustsWind");
        const pressureNowEl = document.getElementById("pressureNowWind");
        const pressureTrendEl = document.getElementById("pressureTrendWind");

        if (windNowEl) {
          windNowEl.textContent =
            (cur.wind_speed != null && cur.wind_direction != null)
              ? `${Math.round(cur.wind_speed)} mph ‚Ä¢ ${degreesToCompass(cur.wind_direction)}`
              : "--";
        }

        if (windGustsEl) {
          windGustsEl.textContent =
            (cur.wind_gusts != null) ? `${Math.round(cur.wind_gusts)} mph` : "--";
        }

        if (pressureNowEl) {
          pressureNowEl.textContent =
            (cur.pressure != null) ? `${cur.pressure.toFixed(1)} hPa` : "--";
        }

        if (pressureTrendEl) {
          pressureTrendEl.textContent = delta ? `${trend} (${delta})` : trend;
        }


      })
      .catch(err => {
        console.error(err);
        document.getElementById("location").textContent = "Error loading weather_data.json";
      });
  </script>
</body>
</html>
